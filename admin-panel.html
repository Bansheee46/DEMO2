<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Админ-панель | Управление товарами</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary-color: #4a6da7;
      --primary-dark: #365486;
      --secondary-color: #87c0cd;
      --light-color: #f5f5f5;
      --dark-color: #333;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --danger-color: #f44336;
      --border-radius: 8px;
      --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: var(--dark-color);
      background-color: #f0f2f5;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    
    .header h1 {
      color: var(--primary-color);
      font-size: 24px;
    }
    
    .btn {
      display: inline-block;
      padding: 10px 20px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      text-align: center;
      transition: var(--transition);
    }
    
    .btn:hover {
      background-color: var(--primary-dark);
    }
    
    .btn-success {
      background-color: var(--success-color);
    }
    
    .btn-success:hover {
      background-color: #3d8b40;
    }
    
    .btn-warning {
      background-color: var(--warning-color);
    }
    
    .btn-warning:hover {
      background-color: #e68a00;
    }
    
    .btn-danger {
      background-color: var(--danger-color);
    }
    
    .btn-danger:hover {
      background-color: #d32f2f;
    }
    
    .card {
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    .card-header {
      padding: 15px 20px;
      background-color: var(--primary-color);
      color: white;
    }
    
    .card-body {
      padding: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      transition: var(--transition);
    }
    
    .form-control:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 2px rgba(74, 109, 167, 0.2);
    }
    
    textarea.form-control {
      resize: vertical;
      min-height: 120px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    table th, table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    
    table th {
      background-color: #f9f9f9;
      font-weight: 600;
    }
    
    table tr:hover {
      background-color: #f5f5f5;
    }
    
    .thumbnail {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
    }
    
    .actions {
      display: flex;
      gap: 10px;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: var(--border-radius);
      background-color: var(--primary-color);
      color: white;
      box-shadow: var(--box-shadow);
      z-index: 1000;
      transform: translateX(120%);
      transition: transform 0.3s ease;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      background-color: var(--success-color);
    }
    
    .notification.error {
      background-color: var(--danger-color);
    }
    
    .notification.warning {
      background-color: var(--warning-color);
    }

    /* Стили для предпросмотра изображения */
    .image-preview {
      margin-top: 10px;
      max-width: 100%;
      height: 200px;
      border: 1px dashed #ddd;
      border-radius: var(--border-radius);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .image-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    /* Стили для панели с товарами */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      margin-top: 10px;
    }
    .product-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(74,109,167,0.07), 0 1.5px 4px rgba(0,0,0,0.04);
      display: flex;
      align-items: flex-start;
      gap: 18px;
      padding: 18px 18px 14px 18px;
      transition: box-shadow 0.3s, transform 0.3s, background 0.3s;
      position: relative;
      opacity: 0;
      transform: translateY(20px);
      animation: productFadeIn 0.5s forwards;
    }
    .product-card.visible { opacity: 1; transform: translateY(0); }
    @keyframes productFadeIn {
      to { opacity: 1; transform: translateY(0); }
    }
    .product-card:hover {
      box-shadow: 0 6px 24px rgba(74,109,167,0.13), 0 2px 8px rgba(0,0,0,0.08);
      background: #f7faff;
      transform: translateY(-2px) scale(1.01);
    }
    .product-card.dragging {
      opacity: 0.6;
      background: #e3e9f6;
      box-shadow: 0 0 0 3px #87c0cd;
    }
    .product-card.drag-over {
      box-shadow: 0 0 0 3px #4a6da7;
      background: #eaf3fa;
    }
    .product-image img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.07);
      background: #f0f2f5;
    }
    .product-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .product-title-input, .product-price-input, .product-sku-input, .product-category-input {
      font-size: 15px;
      padding: 7px 10px;
      border-radius: 5px;
      border: 1px solid #ddd;
      margin-bottom: 2px;
      background: #f9fafd;
      transition: border 0.2s, box-shadow 0.2s;
    }
    .product-title-input:focus, .product-price-input:focus, .product-sku-input:focus, .product-category-input:focus {
      border-color: #4a6da7;
      box-shadow: 0 0 0 2px #87c0cd33;
      background: #fff;
    }
    .product-price-input {
      width: 90px;
      display: inline-block;
    }
    .product-sku-input {
      width: 120px;
      display: inline-block;
    }
    .product-category-input {
      width: 140px;
      display: inline-block;
    }
    .save-inline-btn {
      padding: 6px 14px;
      font-size: 14px;
      border-radius: 5px;
      margin-top: 2px;
    }
    .product-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-left: 8px;
    }
    .product-actions .btn {
      padding: 7px 12px;
      font-size: 15px;
      border-radius: 5px;
    }
    @media (max-width: 700px) {
      .products-grid { grid-template-columns: 1fr; }
      .product-card { flex-direction: column; align-items: stretch; }
      .product-image img { width: 100%; height: 180px; }
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow: auto;
    }
    
    .modal-content {
      background-color: white;
      margin: 50px auto;
      width: 90%;
      max-width: 700px;
      border-radius: var(--border-radius);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      position: relative;
    }
    
    .modal-header {
      padding: 15px 20px;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-footer {
      padding: 15px 20px;
      background-color: #f9f9f9;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .close {
      color: white;
      font-size: 24px;
      cursor: pointer;
    }
    
    /* Loader */
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* --- Улучшенное широкоформатное окно категорий --- */
    #categoriesModal .modal-content {
      min-width: 700px;
      max-width: 900px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(74,109,167,0.08);
      padding: 0;
      overflow: hidden;
      animation: modalFadeIn 0.5s cubic-bezier(.21,.61,.35,1);
      transform-origin: center top;
    }
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(30px) scale(0.97); }
      to   { opacity: 1; transform: none; }
    }
    #categoriesModal .modal-header {
      background: linear-gradient(135deg, #4a6da7 0%, #6d8fc7 100%);
      color: #fff;
      padding: 28px 32px 24px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: none;
      position: relative;
      overflow: hidden;
    }
    #categoriesModal .modal-header:after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #87c0cd 0%, #4a6da7 100%);
      opacity: 0.7;
    }
    #categoriesModal .modal-header h2 {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      font-size: 1.8rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      margin: 0;
      display: flex;
      align-items: center;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    #categoriesModal .modal-header h2:before {
      content: "\f03a";
      font-family: "Font Awesome 5 Free";
      font-weight: 900;
      margin-right: 12px;
      font-size: 1.4rem;
      opacity: 0.9;
    }
    #categoriesModal .close {
      font-size: 1.8rem;
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
      opacity: 0.8;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    #categoriesModal .close:hover {
      opacity: 1;
      background: rgba(255,255,255,0.15);
      transform: rotate(90deg);
    }
    #categoriesModal .modal-body {
      padding: 32px 32px 28px 32px;
      background: transparent;
    }
    #categoriesModal .search-container {
      display: flex;
      align-items: center;
      position: relative;
      margin-bottom: 20px;
    }
    #categoriesModal .search-container:before {
      content: "\f002";
      font-family: "Font Awesome 5 Free";
      font-weight: 900;
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #adb5bd;
      font-size: 0.9rem;
      pointer-events: none;
    }
    #categoriesModal #categorySearch {
      border-radius: 10px;
      border: 1px solid #dee2e6;
      font-size: 1rem;
      padding: 12px 16px 12px 42px;
      background: #fff;
      transition: all 0.25s;
      flex: 1;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    #categoriesModal #categorySearch:focus {
      border-color: #4a6da7;
      outline: none;
      box-shadow: 0 0 0 3px rgba(74,109,167,0.15);
    }
    #categoriesModal #categorySearch::placeholder {
      color: #adb5bd;
      font-style: italic;
    }
    #categoriesModal #showAddCategoryFormBtn {
      font-size: 0.95rem;
      padding: 12px 20px;
      border-radius: 10px;
      background: linear-gradient(135deg, #4caf50 0%, #43a047 100%);
      border: none;
      color: #fff;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(76,175,80,0.2);
      transition: all 0.25s;
      margin-left: 12px;
      letter-spacing: 0.3px;
      position: relative;
      overflow: hidden;
    }
    #categoriesModal #showAddCategoryFormBtn:after {
      content: "";
      position: absolute;
      top: -50%;
      left: -60%;
      width: 200%;
      height: 200%;
      background: rgba(255,255,255,0.15);
      transform: rotate(30deg);
      transition: transform 0.5s;
    }
    #categoriesModal #showAddCategoryFormBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(76,175,80,0.25);
    }
    #categoriesModal #showAddCategoryFormBtn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 8px rgba(76,175,80,0.2);
    }
    #categoriesModal #addCategoryForm {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid #e9ecef;
      margin-bottom: 28px;
      padding: 24px 24px 20px 24px;
      animation: formSlideDown 0.4s cubic-bezier(.21,.61,.35,1);
      position: relative;
    }
    @keyframes formSlideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to   { opacity: 1; transform: none; }
    }
    #categoriesModal #addCategoryForm:before {
      content: "Новая категория";
      position: absolute;
      top: -10px;
      left: 20px;
      background: #4a6da7;
      color: white;
      font-size: 0.8rem;
      padding: 3px 12px;
      border-radius: 20px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(74,109,167,0.2);
    }
    #categoriesModal .form-group {
      margin-bottom: 18px;
    }
    #categoriesModal .form-group label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 6px;
      display: block;
      font-size: 0.95rem;
    }
    #categoriesModal .form-group input[type="text"] {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ced4da;
      padding: 10px 14px;
      font-size: 1rem;
      transition: all 0.25s;
      background: #f8f9fa;
    }
    #categoriesModal .form-group input[type="text"]:focus {
      border-color: #4a6da7;
      outline: none;
      box-shadow: 0 0 0 3px rgba(74,109,167,0.15);
      background: #fff;
    }
    #categoriesModal .image-upload-container {
      display: flex;
      gap: 12px;
      align-items: stretch;
    }
    #categoriesModal .file-upload-wrapper {
      position: relative;
      flex: 1;
      min-height: 80px;
      border: 2px dashed #ced4da;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 10px;
      transition: all 0.25s;
      background: #f8f9fa;
      cursor: pointer;
    }
    #categoriesModal .file-upload-wrapper:hover {
      border-color: #6c757d;
      background: #f1f3f5;
    }
    #categoriesModal .file-upload-wrapper.active {
      border-color: #4caf50;
      background: #f1f8e9;
    }
    #categoriesModal .file-upload-wrapper i {
      font-size: 1.8rem;
      color: #6c757d;
      margin-bottom: 8px;
    }
    #categoriesModal .file-upload-wrapper span {
      font-size: 0.85rem;
      color: #6c757d;
      text-align: center;
    }
    #categoriesModal .file-upload-wrapper input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    #categoriesModal .url-input-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    #categoriesModal .url-input-wrapper input {
      flex: 1;
      border-radius: 8px;
      border: 1px solid #ced4da;
      padding: 10px 14px;
      font-size: 0.95rem;
      transition: all 0.25s;
      background: #f8f9fa;
    }
    #categoriesModal .url-input-wrapper input:focus {
      border-color: #4a6da7;
      outline: none;
      box-shadow: 0 0 0 3px rgba(74,109,167,0.15);
      background: #fff;
    }
    #categoriesModal .url-input-wrapper span {
      font-size: 0.75rem;
      color: #6c757d;
      margin-top: 4px;
    }
    #categoriesModal #newCategoryImagePreview {
      margin-top: 12px;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      position: relative;
    }
    #categoriesModal #newCategoryImagePreview:empty:before {
      content: "Предпросмотр изображения появится здесь";
      color: #6c757d;
      font-style: italic;
      font-size: 0.9rem;
    }
    #categoriesModal #newCategoryImagePreview img {
      max-width: 120px;
      max-height: 120px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      border: 2px solid #fff;
      object-fit: cover;
      transition: transform 0.3s;
    }
    #categoriesModal #newCategoryImagePreview img:hover {
      transform: scale(1.05);
    }
    #categoriesModal .form-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
    }
    #categoriesModal .form-actions button {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.25s;
    }
    #categoriesModal .form-actions .btn-success {
      background: linear-gradient(135deg, #4caf50 0%, #43a047 100%);
      border: none;
      color: #fff;
      box-shadow: 0 4px 12px rgba(76,175,80,0.2);
      min-width: 120px;
    }
    #categoriesModal .form-actions .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(76,175,80,0.25);
    }
    #categoriesModal .form-actions .btn-success:active {
      transform: translateY(1px);
      box-shadow: 0 2px 8px rgba(76,175,80,0.2);
    }
    #categoriesModal .form-actions .btn-cancel {
      background: #f8f9fa;
      border: 1px solid #ced4da;
      color: #6c757d;
    }
    #categoriesModal .form-actions .btn-cancel:hover {
      background: #e9ecef;
      border-color: #adb5bd;
    }
    #categoriesModal #categoriesListContainer {
      position: relative;
    }
    #categoriesModal #categoriesListContainer:empty:before {
      content: "Загрузка категорий...";
      display: block;
      text-align: center;
      padding: 20px;
      color: #6c757d;
      font-style: italic;
    }
    #categoriesModal .categories-help {
      font-size: 0.85rem;
      color: #6c757d;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #categoriesModal .categories-help i {
      color: #4a6da7;
    }
    #categoriesModal #categoriesList {
      margin-top: 10px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid #e9ecef;
      padding: 0;
      overflow: hidden;
    }
    #categoriesModal #categoriesList:empty:before {
      content: "Нет категорий";
      display: block;
      text-align: center;
      padding: 20px;
      color: #6c757d;
      font-style: italic;
    }
    #categoriesModal #categoriesList li {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      border-bottom: 1px solid #e9ecef;
      transition: all 0.25s;
      background: #fff;
      cursor: grab;
      position: relative;
    }
    #categoriesModal #categoriesList li:last-child {
      border-bottom: none;
    }
    #categoriesModal #categoriesList li:hover {
      background: #f8f9fa;
    }
    #categoriesModal #categoriesList li.dragging {
      opacity: 0.7;
      background: #e9ecef;
      box-shadow: 0 0 0 2px #4a6da7;
    }
    #categoriesModal #categoriesList li.drag-over {
      border-top: 2px solid #4a6da7;
    }
    #categoriesModal #categoriesList li:before {
      content: "\f0c9";
      font-family: "Font Awesome 5 Free";
      font-weight: 900;
      color: #adb5bd;
      position: absolute;
      left: 6px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.2s;
    }
    #categoriesModal #categoriesList li:hover:before {
      opacity: 1;
    }
    #categoriesModal #categoriesList img {
      width: 64px;
      height: 64px;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid #fff;
      background: #f8f9fa;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    #categoriesModal #categoriesList li:hover img {
      transform: scale(1.05);
    }
    #categoriesModal .cat-name-input, #categoriesModal .cat-code-input {
      border-radius: 8px;
      border: 1px solid #ced4da;
      padding: 8px 12px;
      font-size: 0.95rem;
      transition: all 0.25s;
      background: #f8f9fa;
    }
    #categoriesModal .cat-name-input {
      font-weight: 600;
      color: #495057;
      flex: 2;
      min-width: 150px;
    }
    #categoriesModal .cat-code-input {
      color: #6c757d;
      width: 130px;
      font-family: monospace;
      font-size: 0.9rem;
    }
    #categoriesModal .cat-name-input:focus, #categoriesModal .cat-code-input:focus {
      border-color: #4a6da7;
      outline: none;
      box-shadow: 0 0 0 3px rgba(74,109,167,0.15);
      background: #fff;
    }
    #categoriesModal .cat-name-input::placeholder, #categoriesModal .cat-code-input::placeholder {
      color: #adb5bd;
      font-style: italic;
    }
    #categoriesModal .category-actions {
      display: flex;
      gap: 6px;
      margin-left: auto;
    }
    #categoriesModal .btn {
      border-radius: 8px;
      font-size: 0.9rem;
      padding: 8px 12px;
      transition: all 0.25s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    #categoriesModal .btn i {
      font-size: 0.85rem;
    }
    #categoriesModal .btn-sm {
      padding: 6px 10px;
    }
    #categoriesModal .btn-warning {
      background: linear-gradient(135deg, #ffb300 0%, #ff9800 100%);
      border: none;
      color: #fff;
      box-shadow: 0 2px 8px rgba(255,152,0,0.2);
    }
    #categoriesModal .btn-warning:hover {
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255,152,0,0.25);
    }
    #categoriesModal .btn-warning:active {
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(255,152,0,0.2);
    }
    #categoriesModal .btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #e53935 100%);
      border: none;
      color: #fff;
      box-shadow: 0 2px 8px rgba(244,67,54,0.2);
    }
    #categoriesModal .btn-danger:hover {
      background: linear-gradient(135deg, #e53935 0%, #d32f2f 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(244,67,54,0.25);
    }
    #categoriesModal .btn-danger:active {
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(244,67,54,0.2);
    }
    #categoriesModal .btn-secondary {
      background: linear-gradient(135deg, #78909c 0%, #607d8b 100%);
      border: none;
      color: #fff;
      box-shadow: 0 2px 8px rgba(96,125,139,0.2);
    }
    #categoriesModal .btn-secondary:hover {
      background: linear-gradient(135deg, #607d8b 0%, #546e7a 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(96,125,139,0.25);
    }
    #categoriesModal .btn-secondary:active {
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(96,125,139,0.2);
    }
    #categoriesModal .tooltip {
      position: relative;
      display: inline-block;
    }
    #categoriesModal .tooltip .tooltiptext {
      visibility: hidden;
      width: 120px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.8rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    #categoriesModal .tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #333 transparent transparent transparent;
    }
    #categoriesModal .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    #categoriesModal hr {
      border: none;
      border-top: 1px solid #dee2e6;
      margin: 32px 0 24px 0;
      position: relative;
    }
    #categoriesModal hr:before {
      content: "или";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #f8f9fa;
      padding: 0 16px;
      color: #6c757d;
      font-size: 0.9rem;
    }
    #categoriesModal #categoriesError {
      color: #f44336;
      font-weight: 500;
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 6px;
      background: #ffebee;
      border-left: 4px solid #f44336;
      display: none;
    }
    #categoriesModal #categoriesError:not(:empty) {
      display: block;
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to   { opacity: 1; transform: none; }
    }
    @media (max-width: 900px) {
      #categoriesModal .modal-content {
        min-width: 95vw;
        max-width: 98vw;
        margin: 10px auto;
      }
      #categoriesModal .modal-header {
        padding: 20px 16px 16px 16px;
      }
      #categoriesModal .modal-body {
        padding: 20px 16px;
      }
      #categoriesModal .image-upload-container {
        flex-direction: column;
      }
      #categoriesModal .cat-code-input {
        width: 100px;
      }
      #categoriesModal .category-actions {
        flex-wrap: wrap;
      }
    }
    
    /* --- Анимации и подсказки при входе --- */
    .intro-tooltip {
      position: absolute;
      background: #fff;
      border-radius: 8px;
      padding: 12px 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      font-size: 0.9rem;
      color: #495057;
      z-index: 1000;
      max-width: 250px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s, transform 0.3s;
      border-left: 4px solid #4a6da7;
    }
    .intro-tooltip.active {
      opacity: 1;
      pointer-events: auto;
    }
    .intro-tooltip:after {
      content: "";
      position: absolute;
      width: 12px;
      height: 12px;
      background: #fff;
      transform: rotate(45deg);
    }
    .intro-tooltip.top:after {
      bottom: -6px;
      left: 20px;
    }
    .intro-tooltip.bottom:after {
      top: -6px;
      left: 20px;
    }
    .intro-tooltip.right:after {
      left: -6px;
      top: 50%;
      margin-top: -6px;
    }
    .intro-tooltip.left:after {
      right: -6px;
      top: 50%;
      margin-top: -6px;
    }
    .intro-tooltip h4 {
      margin: 0 0 6px 0;
      font-weight: 600;
      color: #4a6da7;
      font-size: 1rem;
    }
    .intro-tooltip p {
      margin: 0 0 8px 0;
      line-height: 1.4;
    }
    .intro-tooltip .btn-next {
      background: #4a6da7;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      float: right;
      transition: all 0.2s;
    }
    .intro-tooltip .btn-next:hover {
      background: #365486;
    }
    .intro-tooltip .btn-skip {
      background: none;
      border: none;
      color: #6c757d;
      font-size: 0.8rem;
      cursor: pointer;
      padding: 6px 0;
      transition: all 0.2s;
    }
    .intro-tooltip .btn-skip:hover {
      color: #495057;
    }
    .highlight-element {
      position: relative;
    }
    .highlight-element:before {
      content: "";
      position: absolute;
      top: -4px;
      left: -4px;
      right: -4px;
      bottom: -4px;
      border-radius: 8px;
      background: rgba(74,109,167,0.1);
      z-index: -1;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(74,109,167,0.4); }
      70% { box-shadow: 0 0 0 10px rgba(74,109,167,0); }
      100% { box-shadow: 0 0 0 0 rgba(74,109,167,0); }
    }
    .welcome-animation {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.85);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: #fff;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s;
    }
    .welcome-animation.active {
      opacity: 1;
      pointer-events: auto;
      animation: welcomeFadeIn 0.5s forwards;
    }
    @keyframes welcomeFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .welcome-animation h2 {
      font-size: 2.5rem;
      margin: 0 0 20px 0;
      font-weight: 700;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp 0.6s forwards 0.2s;
    }
    .welcome-animation p {
      font-size: 1.2rem;
      margin: 0 0 30px 0;
      max-width: 600px;
      text-align: center;
      line-height: 1.6;
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp 0.6s forwards 0.4s;
    }
    .welcome-animation .btn-start {
      background: linear-gradient(135deg, #4a6da7 0%, #87c0cd 100%);
      color: #fff;
      border: none;
      padding: 12px 30px;
      border-radius: 30px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s;
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp 0.6s forwards 0.6s;
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(74,109,167,0.4);
    }
    .welcome-animation .btn-start:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 25px rgba(74,109,167,0.5);
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-store"></i> Админ-панель управления товарами</h1>
      <div>
        <button class="btn" id="manageCategoriesBtn"><i class="fas fa-tags"></i> Категории</button>
        <button class="btn" id="addProductBtn"><i class="fas fa-plus"></i> Добавить товар</button>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">
        <h2>Список товаров</h2>
      </div>
      <div class="card-body">
        <div style="margin-bottom: 18px; display: flex; align-items: center; gap: 12px;">
          <input type="text" id="productSearchInput" class="form-control" placeholder="Поиск по товарам (название, артикул, категория)..." style="max-width: 350px;">
          <span id="productSearchCount" style="color: #888; font-size: 14px;"></span>
        </div>
        <div id="productsContainer">
          <div class="loader"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Модальное окно для добавления/редактирования товара -->
  <div class="modal" id="productModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Добавить товар</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <form id="productForm">
          <input type="hidden" id="productId">
          <div class="form-grid">
            <div class="form-group">
              <label for="title">Название товара *</label>
              <input type="text" class="form-control" id="title" required>
            </div>
            <div class="form-group">
              <label for="price">Цена *</label>
              <input type="number" class="form-control" id="price" min="0" step="0.01" required>
            </div>
          </div>
          <div class="form-group">
            <label for="sku">Артикул</label>
            <input type="text" class="form-control" id="sku" placeholder="Введите артикул товара">
          </div>
          <div class="form-group">
            <label for="description">Описание</label>
            <textarea class="form-control" id="description"></textarea>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="category">Категория</label>
              <select class="form-control" id="category">
                <option value="electronics">Электроника</option>
                <option value="toys">Игрушки</option>
                <option value="clothing">Одежда</option>
                <option value="accessories">Аксессуары</option>
                <option value="other">Другое</option>
              </select>
            </div>
            <div class="form-group">
              <label for="subcategory">Подкатегория</label>
              <select class="form-control" id="subcategory">
                <option value="">Выберите подкатегорию</option>
              </select>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="imageUrl">URL изображения</label>
              <input type="text" class="form-control" id="imageUrl">
              <div class="image-preview" id="imagePreview">
                <img src="https://via.placeholder.com/400x300?text=Нет+изображения" alt="Предпросмотр" id="previewImage">
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="cancelBtn">Отмена</button>
        <button class="btn btn-success" id="saveBtn">Сохранить</button>
      </div>
    </div>
  </div>
  
  <!-- Модальное окно для управления категориями -->
  <div class="modal" id="categoriesModal">
    <!-- Приветственная анимация при первом входе -->
    <div class="welcome-animation" id="welcomeAnimation">
      <h2>Управление категориями</h2>
      <p>Добро пожаловать в обновленный интерфейс управления категориями! Здесь вы можете добавлять, редактировать и сортировать категории товаров вашего магазина.</p>
      <button class="btn-start" id="startTourBtn">Начать знакомство <i class="fas fa-arrow-right"></i></button>
    </div>
    
    <div class="modal-content">
      <div class="modal-header">
        <h2>Управление категориями</h2>
        <span class="close" id="closeCategoriesModal">&times;</span>
      </div>
      <div class="modal-body">
        <!-- Подсказка для поиска -->
        <div class="intro-tooltip search-tooltip top" id="searchTooltip">
          <h4>Быстрый поиск</h4>
          <p>Используйте поиск, чтобы быстро найти нужную категорию по названию или коду</p>
          <button class="btn-skip">Пропустить тур</button>
          <button class="btn-next">Далее <i class="fas fa-arrow-right"></i></button>
        </div>
        
        <div class="search-container">
          <input type="text" id="categorySearch" class="form-control" placeholder="Поиск по категориям...">
          <button class="btn btn-success" id="showAddCategoryFormBtn" type="button"><i class="fas fa-plus"></i> Добавить категорию</button>
        </div>
        
        <!-- Подсказка для добавления -->
        <div class="intro-tooltip add-tooltip left" id="addTooltip">
          <h4>Добавление категорий</h4>
          <p>Нажмите здесь, чтобы добавить новую категорию товаров с названием и изображением</p>
          <button class="btn-skip">Пропустить тур</button>
          <button class="btn-next">Далее <i class="fas fa-arrow-right"></i></button>
        </div>
        
        <form id="addCategoryForm" style="display:none;">
          <div class="form-group">
            <label for="newCategoryName">Название категории <span style="color:#f44336;">*</span></label>
            <input type="text" id="newCategoryName" class="form-control" maxlength="20" required placeholder="Например: Электроника">
          </div>
          
          <div class="form-group">
            <label for="newCategoryImage">Фото категории <span style="color:#f44336;">*</span></label>
            <div class="image-upload-container">
              <div class="file-upload-wrapper">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Перетащите файл или кликните для загрузки</span>
                <input type="file" id="newCategoryImage" accept="image/*">
              </div>
              <div class="url-input-wrapper">
                <input type="url" id="newCategoryImageUrl" class="form-control" placeholder="Или вставьте URL изображения">
                <span>Поддерживаются форматы: JPG, PNG, GIF, WebP</span>
              </div>
            </div>
            <div id="newCategoryImagePreview"></div>
          </div>
          
          <div class="form-actions">
            <div>
              <div id="categoriesError"></div>
            </div>
            <div>
              <button class="btn btn-cancel" id="cancelAddCategoryBtn" type="button">Отмена</button>
              <button class="btn btn-success" type="submit"><i class="fas fa-save"></i> Сохранить</button>
            </div>
          </div>
        </form>
        
        <div class="categories-help">
          <i class="fas fa-info-circle"></i>
          <span>Перетаскивайте категории для изменения порядка. Нажмите на категорию для управления подкатегориями.</span>
        </div>
        
        <!-- Подсказка для списка категорий -->
        <div class="intro-tooltip list-tooltip right" id="listTooltip">
          <h4>Управление списком</h4>
          <p>Здесь отображаются все категории. Вы можете перетаскивать их для изменения порядка, редактировать или удалять</p>
          <button class="btn-skip">Пропустить тур</button>
          <button class="btn-next">Далее <i class="fas fa-arrow-right"></i></button>
        </div>
        
        <div id="categoriesListContainer">
          <ul id="categoriesList"></ul>
        </div>
        
        <hr>
        
        <!-- Подсказка для подкатегорий -->
        <div class="intro-tooltip subcats-tooltip bottom" id="subcatsTooltip">
          <h4>Подкатегории</h4>
          <p>Для каждой категории вы можете создать подкатегории, которые помогут точнее организовать ваши товары</p>
          <button class="btn-skip">Пропустить тур</button>
          <button class="btn-next">Завершить <i class="fas fa-check"></i></button>
        </div>
        
        <div id="subcategoriesSection" style="display:none;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <button class="btn btn-secondary" id="backToCategoriesBtn" type="button"><i class="fas fa-arrow-left"></i> Назад к категориям</button>
            <h3 style="font-size:18px; margin:0;">Подкатегории для <span id="selectedCategoryName" style="font-weight:600;color:#4a6da7;"></span></h3>
          </div>
          
          <ul id="subcategoriesList"></ul>
          
          <form id="addSubcategoryForm" style="margin-top:16px;">
            <div class="form-group" style="display:flex;gap:12px;margin-bottom:8px;">
              <input type="text" id="newSubcategoryName" class="form-control" placeholder="Название подкатегории" maxlength="20" required style="flex:1;">
              <button class="btn btn-success" type="submit"><i class="fas fa-plus"></i> Добавить</button>
            </div>
            <div id="subcategoriesError" style="color:#f44336;"></div>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Уведомление -->
  <div class="notification" id="notification"></div>
  
  <script>
    // Базовый URL API сервера
    const API_BASE_URL = '';
    
    // Элементы DOM
    const productsContainer = document.getElementById('productsContainer');
    const addProductBtn = document.getElementById('addProductBtn');
    const productModal = document.getElementById('productModal');
    const modalTitle = document.getElementById('modalTitle');
    const productForm = document.getElementById('productForm');
    const productIdInput = document.getElementById('productId');
    const titleInput = document.getElementById('title');
    const priceInput = document.getElementById('price');
    const descriptionInput = document.getElementById('description');
    const categoryInput = document.getElementById('category');
    const subcategoryInput = document.getElementById('subcategory');
    const imageUrlInput = document.getElementById('imageUrl');
    const skuInput = document.getElementById('sku');
    const previewImage = document.getElementById('previewImage');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const closeBtn = document.querySelector('.close');
    const notification = document.getElementById('notification');
    const manageCategoriesBtn = document.getElementById('manageCategoriesBtn');
    const categoriesModal = document.getElementById('categoriesModal');
    const closeCategoriesModal = document.getElementById('closeCategoriesModal');
    const categoriesList = document.getElementById('categoriesList');
    const addCategoryForm = document.getElementById('addCategoryForm');
    const newCategoryName = document.getElementById('newCategoryName');
    const categoriesError = document.getElementById('categoriesError');
    const subcategoriesSection = document.getElementById('subcategoriesSection');
    const subcategoriesList = document.getElementById('subcategoriesList');
    const addSubcategoryForm = document.getElementById('addSubcategoryForm');
    const newSubcategoryName = document.getElementById('newSubcategoryName');
    const subcategoriesError = document.getElementById('subcategoriesError');
    const selectedCategoryName = document.getElementById('selectedCategoryName');
    const showAddCategoryFormBtn = document.getElementById('showAddCategoryFormBtn');
    const cancelAddCategoryBtn = document.getElementById('cancelAddCategoryBtn');
    const newCategoryImage = document.getElementById('newCategoryImage');
    const newCategoryImageUrl = document.getElementById('newCategoryImageUrl');
    const newCategoryImagePreview = document.getElementById('newCategoryImagePreview');
    const categorySearch = document.getElementById('categorySearch');
    const categoriesListContainer = document.getElementById('categoriesListContainer');
    
    let dragSrcEl = null;
    
    // Упрощенная функция для запросов к API
    function fetchWithCsrf(url, options = {}) {
      return fetch(url, {
        ...options,
        headers: options.headers || {},
        credentials: 'include'
      });
    }
    
    // Загрузка товаров при загрузке страницы
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // Сначала загружаем категории
        await loadCategories();
        // Затем товары
        await loadProducts();
      } catch (error) {
        console.error('Ошибка при инициализации:', error);
        showNotification('Ошибка при инициализации страницы', 'error');
      }
    });
    
    // Обработчики событий
    addProductBtn.addEventListener('click', openAddProductModal);
    cancelBtn.addEventListener('click', closeModal);
    closeBtn.addEventListener('click', closeModal);
    saveBtn.addEventListener('click', saveProduct);
    imageUrlInput.addEventListener('input', updateImagePreview);
    manageCategoriesBtn.addEventListener('click', openCategoriesModal);
    closeCategoriesModal.addEventListener('click', closeCategories);
    window.addEventListener('click', function(e){if(e.target===categoriesModal)closeCategories();});
    addCategoryForm.addEventListener('submit', addCategory);
    categoryInput.addEventListener('change', loadSubcategoriesForProduct);
    
    // Закрытие модального окна при клике вне его
    window.addEventListener('click', function(event) {
      if (event.target === productModal) {
        closeModal();
      }
    });
    
    // Функция для загрузки товаров с сервера
    async function loadProducts() {
      try {
        productsContainer.innerHTML = '<div class="loader"></div>';
        
        const response = await fetchWithCsrf(`${API_BASE_URL}/api/products`);
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.message || 'Ошибка при получении товаров');
        }
        
        renderProducts(data.products);
      } catch (error) {
        console.error('Ошибка при загрузке товаров:', error);
        productsContainer.innerHTML = `<p>Ошибка при загрузке товаров: ${error.message}</p>`;
        showNotification('Не удалось загрузить товары с сервера', 'error');
      }
    }
    
    // Отображение товаров на странице
    function renderProducts(products) {
      if (!products || products.length === 0) {
        productsContainer.innerHTML = `
          <div class="empty-state" style="text-align: center; padding: 40px 20px;">
            <i class="fas fa-box-open" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
            <h3>Товары не найдены</h3>
            <p>В базе данных пока нет товаров. Нажмите "Добавить товар", чтобы создать первый товар.</p>
          </div>
        `;
        document.getElementById('productSearchCount').textContent = '';
        return;
      }
      // Сохраняем полный список для поиска
      window._allProducts = products;
      let html = '<div class="products-grid">';
      products.forEach(product => {
        const imageUrl = product.image_url 
          ? (product.image_url.startsWith('http') || product.image_url.startsWith('/') 
             ? product.image_url 
             : `${API_BASE_URL}/${product.image_url}`)
          : 'https://via.placeholder.com/400x300?text=Нет+изображения';
        html += `
          <div class="product-card" data-id="${product.id}">
            <div class="product-image">
              <img src="${imageUrl}" alt="${product.title}">
            </div>
            <div class="product-info">
              <input type="text" class="product-title-input form-control" value="${product.title}" style="font-weight:600; font-size:16px; margin-bottom:4px;">
              <input type="number" class="product-price-input form-control" value="${product.price}" style="width:100px; display:inline-block; margin-bottom:4px;"> ₽
              ${product.category ? `<select class="product-category-input form-control" style="width:140px; display:inline-block; margin-bottom:4px;"></select>` : ''}
              ${product.sku ? `<input type="text" class="product-sku-input form-control" value="${product.sku}" placeholder="Артикул" style="width:120px; display:inline-block; margin-bottom:4px;">` : '<input type="text" class="product-sku-input form-control" value="" placeholder="Артикул" style="width:120px; display:inline-block; margin-bottom:4px;">'}
              <button class="btn btn-success btn-sm save-inline-btn" style="display:none; margin-top:4px;"><i class="fas fa-save"></i> Сохранить</button>
            </div>
            <div class="product-actions">
              <button class="btn btn-warning btn-sm edit-btn" data-id="${product.id}">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-danger btn-sm delete-btn" data-id="${product.id}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      });
      html += '</div>';
      productsContainer.innerHTML = html;
      document.getElementById('productSearchCount').textContent = `Показано: ${products.length}`;
      // После отрисовки — подгружаем категории в select
      document.querySelectorAll('.product-category-input').forEach(select => {
        select.innerHTML = window.categoriesCache.map(cat => `<option value="${cat.code}">${cat.name}</option>`).join('');
        const card = select.closest('.product-card');
        if (card && card.dataset.id) {
          const prod = products.find(p => p.id == card.dataset.id);
          if (prod && prod.category) select.value = prod.category;
        }
      });
      // Инлайн-редактирование: показываем кнопку сохранить при изменении
      document.querySelectorAll('.product-card').forEach(card => {
        const titleInput = card.querySelector('.product-title-input');
        const priceInput = card.querySelector('.product-price-input');
        const skuInput = card.querySelector('.product-sku-input');
        const catInput = card.querySelector('.product-category-input');
        const saveBtn = card.querySelector('.save-inline-btn');
        [titleInput, priceInput, skuInput, catInput].forEach(input => {
          if (input) input.addEventListener('input', () => { saveBtn.style.display = 'inline-block'; });
        });
        if (saveBtn) {
          saveBtn.addEventListener('click', async () => {
            const id = card.dataset.id;
            const newTitle = titleInput.value.trim();
            const newPrice = priceInput.value.trim();
            const newSku = skuInput.value.trim();
            const newCat = catInput ? catInput.value : '';
            if (!newTitle || !newPrice) {
              showNotification('Название и цена обязательны', 'error');
              return;
            }
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
              const res = await fetchWithCsrf(`${API_BASE_URL}/api/products/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: newTitle, price: newPrice, sku: newSku, category: newCat })
              });
              const data = await res.json();
              if (data.success) {
                showNotification('Товар обновлён', 'success');
                saveBtn.style.display = 'none';
                loadProducts();
              } else {
                showNotification(data.message || 'Ошибка', 'error');
              }
            } catch (e) {
              showNotification('Ошибка при сохранении', 'error');
            }
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Сохранить';
          });
        }
      });
      makeProductsDraggable();
      
      // Добавляем обработчики для кнопок редактирования и удаления
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const productId = this.getAttribute('data-id');
          openEditProductModal(productId);
        });
      });
      
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const productId = this.getAttribute('data-id');
          confirmDeleteProduct(productId);
        });
      });
    }
    
    // Функция для отображения модального окна добавления товара
    function openAddProductModal() {
      modalTitle.textContent = 'Добавить товар';
      productIdInput.value = '';
      productForm.reset();
      previewImage.src = 'https://via.placeholder.com/400x300?text=Нет+изображения';
      loadSubcategoriesForProduct();
      productModal.style.display = 'block';
    }
    
    // Открытие модального окна для редактирования товара
    async function openEditProductModal(productId) {
      try {
        modalTitle.textContent = 'Редактирование товара';
        
        // Загружаем данные товара с сервера
        const response = await fetchWithCsrf(`${API_BASE_URL}/api/products/${productId}`);
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.message || 'Товар не найден');
        }
        
        const product = data.product;
        
        // Заполняем форму данными товара
        productIdInput.value = product.id;
        titleInput.value = product.title || '';
        priceInput.value = product.price || '';
        descriptionInput.value = product.description || '';
        categoryInput.value = product.category || '';
        skuInput.value = product.sku || '';
        imageUrlInput.value = product.image_url || '';
        
        // Сохраняем текущую подкатегорию и загружаем список подкатегорий для выбранной категории
        if (product.subcategory_code) {
          subcategoryInput.setAttribute('data-current', product.subcategory_code);
        }
        loadSubcategoriesForProduct();
        
        updateImagePreview();
        productModal.style.display = 'block';
      } catch (error) {
        console.error('Ошибка при загрузке товара:', error);
        showNotification('Не удалось загрузить данные товара', 'error');
      }
    }
    
    // Функция для закрытия модального окна
    function closeModal() {
      productModal.style.display = 'none';
    }
    
    // Функция для обновления предпросмотра изображения
    function updateImagePreview() {
      const imageUrl = imageUrlInput.value.trim();
      previewImage.src = imageUrl || 'https://via.placeholder.com/400x300?text=Нет+изображения';
      
      // Обработка ошибок загрузки изображения
      previewImage.onerror = function() {
        previewImage.src = 'https://via.placeholder.com/400x300?text=Ошибка+загрузки';
      };
    }
    
    // Функция для сохранения товара (добавление или обновление)
    async function saveProduct() {
      try {
        // Валидация формы
        if (!titleInput.value.trim()) {
          showNotification('Название товара обязательно для заполнения', 'warning');
          return;
        }
        if (!priceInput.value || isNaN(parseFloat(priceInput.value)) || parseFloat(priceInput.value) < 0) {
          showNotification('Введите корректную цену', 'warning');
          return;
        }
        // Проверка обязательности подкатегории, если есть подкатегории
        const categoryCode = categoryInput.value;
        const subcats = subcategoriesCache[categoryCode];
        if (subcats && subcats.length > 0 && !subcategoryInput.value) {
          showNotification('Выберите подкатегорию для товара', 'warning');
          return;
        }
        
        // Сбор данных из формы
        const productData = {
          title: titleInput.value.trim(),
          price: parseFloat(priceInput.value),
          description: descriptionInput.value.trim(),
          category: categoryInput.value,
          subcategory_code: subcategoryInput.value,
          image_url: imageUrlInput.value.trim(),
          sku: skuInput.value.trim()
        };
        
        const productId = productIdInput.value;
        let url = `${API_BASE_URL}/api/products`;
        let method = 'POST';
        
        // Если редактируем существующий товар
        if (productId) {
          url = `${API_BASE_URL}/api/products/${productId}`;
          method = 'PUT';
        }
        
        // Отправка запроса на сервер
        const response = await fetchWithCsrf(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(productData)
        });
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.message || 'Ошибка при сохранении товара');
        }
        
        // Закрытие модального окна и обновление списка товаров
        closeModal();
        loadProducts();
        
        showNotification(productId ? 'Товар успешно обновлен' : 'Товар успешно добавлен', 'success');
      } catch (error) {
        console.error('Ошибка при сохранении товара:', error);
        showNotification(`Ошибка при сохранении товара: ${error.message}`, 'error');
      }
    }
    
    // Функция для подтверждения удаления товара
    function confirmDeleteProduct(productId) {
      if (confirm('Вы действительно хотите удалить этот товар?')) {
        deleteProduct(productId);
      }
    }
    
    // Функция для удаления товара
    async function deleteProduct(productId) {
      try {
        const response = await fetchWithCsrf(`${API_BASE_URL}/api/products/${productId}`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.message || 'Ошибка при удалении товара');
        }
        
        // Обновление списка товаров
        loadProducts();
        showNotification('Товар успешно удален', 'success');
      } catch (error) {
        console.error('Ошибка при удалении товара:', error);
        showNotification(`Ошибка при удалении товара: ${error.message}`, 'error');
      }
    }
    
    // Функция для отображения уведомлений
    function showNotification(message, type = 'info') {
      notification.textContent = message;
      notification.className = 'notification';
      notification.classList.add(type);
      notification.classList.add('show');
      
      // Скрываем уведомление через 3 секунды
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // Функция для получения названия категории
    function getCategoryName(categoryCode) {
      const categories = {
        'electronics': 'Электроника',
        'toys': 'Игрушки',
        'clothing': 'Одежда',
        'accessories': 'Аксессуары',
        'other': 'Другое'
      };
      
      return categories[categoryCode] || categoryCode;
    }
    
    async function openCategoriesModal() {
      await loadCategories();
      categoriesModal.style.display = 'block';
    }
    function closeCategories() {
      categoriesModal.style.display = 'none';
      categoriesError.textContent = '';
      addCategoryForm.reset();
      subcategoriesSection.style.display = 'none';
      subcategoriesList.innerHTML = '';
      subcategoriesError.textContent = '';
      selectedCategoryName.textContent = '';
      currentCategoryCode = null;
    }
    async function loadCategories() {
      const res = await fetchWithCsrf(`${API_BASE_URL}/api/categories`);
      const data = await res.json();
      if(data.success) {
        categoriesCache = data.categories;
        renderCategoriesList();
        updateCategorySelect();
      }
    }
    function renderCategoriesList() {
      categoriesList.innerHTML = '';
      categoriesCache.forEach(cat => {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.gap = '8px';
        li.style.marginBottom = '6px';
        li.innerHTML = `
          <img src="${cat.image_url||'https://via.placeholder.com/60x60?text=Фото'}" style="width:48px;height:48px;object-fit:cover;border-radius:6px;">
          <input type="text" value="${cat.name}" style="flex:2;min-width:80px;" class="form-control cat-name-input">
          <input type="text" value="${cat.code}" style="width:120px;" class="form-control cat-code-input">
          <button class='btn btn-warning btn-sm save-cat-btn'><i class='fas fa-save'></i></button>
          <button class='btn btn-danger btn-sm del-cat-btn'><i class='fas fa-trash'></i></button>
          <button class='btn btn-secondary btn-sm show-subcats-btn'><i class='fas fa-sitemap'></i></button>
        `;
        // События для кнопок
        li.querySelector('.save-cat-btn').onclick = async () => {
          const newName = li.querySelector('.cat-name-input').value.trim();
          const newCode = li.querySelector('.cat-code-input').value.trim();
          if (!newName || !newCode) {
            categoriesError.textContent = 'Название и код обязательны';
            return;
          }
          await editCategory(cat.id, newName, newCode);
        };
        li.querySelector('.del-cat-btn').onclick = async () => {
          if (confirm('Удалить категорию?')) await deleteCategory(cat.id);
        };
        li.querySelector('.show-subcats-btn').onclick = () => {
          currentCategoryCode = cat.code;
          selectedCategoryName.textContent = cat.name;
          subcategoriesSection.style.display = 'block';
          categoriesListContainer.style.display = 'none';
          loadSubcategories(cat.code);
        };
        categoriesList.appendChild(li);
      });
      makeCategoriesDraggable();
    }
    async function addCategory(e) {
      e.preventDefault();
      categoriesError.textContent = '';
      const name = newCategoryName.value.trim();
      if (!name) return;
      const code = generateCategoryCode(name);
      let image_url = '';
      // 1. Если выбран файл — загружаем на сервер
      if (newCategoryImage.files && newCategoryImage.files[0]) {
        const formData = new FormData();
        formData.append('file', newCategoryImage.files[0]);
        const res = await fetch(`${API_BASE_URL}/api/upload-category-image`, { method: 'POST', body: formData });
        const data = await res.json();
        if (!data.success) {
          categoriesError.textContent = data.message || 'Ошибка загрузки фото';
          return;
        }
        image_url = data.url;
      } else if (newCategoryImageUrl.value.trim()) {
        // 2. Если указан url
        image_url = newCategoryImageUrl.value.trim();
      } else {
        categoriesError.textContent = 'Добавьте фото категории (файл или URL)';
        return;
      }
      // 3. Отправляем категорию
      const res = await fetchWithCsrf(`${API_BASE_URL}/api/categories`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, code, image_url })
      });
      const data = await res.json();
      if (data.success) {
        addCategoryForm.reset();
        addCategoryForm.style.display = 'none';
        showAddCategoryFormBtn.style.display = '';
        await loadCategories();
        showNotification('Категория добавлена', 'success');
      } else {
        categoriesError.textContent = data.message || 'Ошибка';
      }
    }
    async function deleteCategory(id) {
      if(!confirm('Удалить категорию?'))return;
      const res = await fetchWithCsrf(`${API_BASE_URL}/api/categories/${id}`,{method:'DELETE'});
      const data = await res.json();
      if(data.success){
        await loadCategories();
      }else{
        categoriesError.textContent = data.message||'Ошибка';
      }
    }
    function editCategoryPrompt(id) {
      const cat = categoriesCache.find(c=>c.id===id);
      if(!cat)return;
      const newName = prompt('Новое название категории:',cat.name);
      if(newName===null)return;
      const newCode = generateCategoryCode(newName);
      editCategory(id,newName.trim(),newCode);
    }
    async function editCategory(id, name, code) {
      // Получаем текущий li
      const li = [...categoriesList.children].find(li => li.querySelector('.save-cat-btn'));
      let image_url = '';
      // Проверяем, есть ли input для смены фото (можно доработать для inline-редактирования)
      const img = li.querySelector('img');
      if (img && img.dataset.newFile) {
        // Если пользователь выбрал новый файл
        const formData = new FormData();
        formData.append('file', img.dataset.newFile);
        const res = await fetch(`${API_BASE_URL}/api/upload-category-image`, { method: 'POST', body: formData });
        const data = await res.json();
        if (!data.success) {
          categoriesError.textContent = data.message || 'Ошибка загрузки фото';
          return;
        }
        image_url = data.url;
      } else {
        image_url = img ? img.src : '';
      }
      if (!name || !code || !image_url) {
        categoriesError.textContent = 'Название, код и фото обязательны';
        return;
      }
      const res = await fetchWithCsrf(`${API_BASE_URL}/api/categories/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, code, image_url })
      });
      const data = await res.json();
      if (data.success) {
        await loadCategories();
        showNotification('Категория обновлена', 'success');
      } else {
        categoriesError.textContent = data.message || 'Ошибка';
      }
    }
    function updateCategorySelect() {
      categoryInput.innerHTML = categoriesCache.map(cat=>`<option value="${cat.code}">${cat.name}</option>`).join('');
    }
    function generateCategoryCode(name) {
      // Транслитерация + нижний регистр + подчёркивания
      return name.toLowerCase()
        .replace(/ё/g,'e')
        .replace(/[а-я]/g, c => translitMap[c] || '')
        .replace(/[^a-z0-9]+/g,'_')
        .replace(/^_+|_+$/g,'')
        .replace(/_+/g,'_');
    }
    const translitMap = {
      'а':'a','б':'b','в':'v','г':'g','д':'d','е':'e','ж':'zh','з':'z','и':'i','й':'y','к':'k','л':'l','м':'m','н':'n','о':'o','п':'p','р':'r','с':'s','т':'t','у':'u','ф':'f','х':'h','ц':'ts','ч':'ch','ш':'sh','щ':'sch','ы':'y','э':'e','ю':'yu','я':'ya'
    };
    // При открытии модалки товара — обновлять список категорий
    addProductBtn.addEventListener('click',()=>{loadCategories();});

    // Показать подкатегории для выбранной категории
    categoriesList.addEventListener('click', async function(e) {
      const li = e.target.closest('li');
      if (!li) return;
      const idx = Array.from(categoriesList.children).indexOf(li);
      const cat = categoriesCache[idx];
      if (!cat) return;
      currentCategoryCode = cat.code;
      selectedCategoryName.textContent = cat.name;
      subcategoriesSection.style.display = 'block';
      await loadSubcategories(cat.code);
    });

    async function loadSubcategories(categoryCode) {
      subcategoriesList.innerHTML = '<li style="color:#888;">Загрузка...</li>';
      subcategoriesError.textContent = '';
      try {
        const res = await fetchWithCsrf(`${API_BASE_URL}/api/subcategories?category=${encodeURIComponent(categoryCode)}`);
        const data = await res.json();
        if (data.success) {
          renderSubcategoriesList(data.subcategories);
        } else {
          subcategoriesList.innerHTML = '<li style="color:#f44336;">Ошибка загрузки</li>';
        }
      } catch (e) {
        subcategoriesList.innerHTML = '<li style="color:#f44336;">Ошибка загрузки</li>';
      }
    }

    function renderSubcategoriesList(subs) {
      subcategoriesList.innerHTML = '';
      if (!subs.length) {
        subcategoriesList.innerHTML = '<li style="color:#888;">Нет подкатегорий</li>';
        return;
      }
      subs.forEach(sub => {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.gap = '8px';
        li.style.marginBottom = '6px';
        li.innerHTML = `<span style="flex:1;">${sub.name} <span style='color:#888;font-size:12px;'>[${sub.code}]</span></span>`+
          `<button class='btn btn-warning btn-sm' data-edit='${sub.id}'><i class='fas fa-edit'></i></button>`+
          `<button class='btn btn-danger btn-sm' data-del='${sub.id}'><i class='fas fa-trash'></i></button>`;
        subcategoriesList.appendChild(li);
      });
    }

    // Добавление подкатегории
    addSubcategoryForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      subcategoriesError.textContent = '';
      const name = newSubcategoryName.value.trim();
      if (!name || !currentCategoryCode) return;
      const code = generateCategoryCode(name);
      try {
        const res = await fetchWithCsrf(`${API_BASE_URL}/api/subcategories`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, code, category_code: currentCategoryCode })
        });
        const data = await res.json();
        if (data.success) {
          addSubcategoryForm.reset();
          await loadSubcategories(currentCategoryCode);
        } else {
          subcategoriesError.textContent = data.message || 'Ошибка';
        }
      } catch (e) {
        subcategoriesError.textContent = 'Ошибка добавления';
      }
    });

    // Удаление/редактирование подкатегории
    subcategoriesList.addEventListener('click', async function(e) {
      const btnDel = e.target.closest('[data-del]');
      const btnEdit = e.target.closest('[data-edit]');
      if (btnDel) {
        if (!confirm('Удалить подкатегорию?')) return;
        const id = btnDel.getAttribute('data-del');
        try {
          const res = await fetchWithCsrf(`${API_BASE_URL}/api/subcategories/${id}`, { method: 'DELETE' });
          const data = await res.json();
          if (data.success) {
            await loadSubcategories(currentCategoryCode);
          } else {
            subcategoriesError.textContent = data.message || 'Ошибка';
          }
        } catch (e) {
          subcategoriesError.textContent = 'Ошибка удаления';
        }
      } else if (btnEdit) {
        const id = btnEdit.getAttribute('data-edit');
        const li = btnEdit.closest('li');
        const nameSpan = li.querySelector('span');
        const oldName = nameSpan ? nameSpan.textContent.split('[')[0].trim() : '';
        const newName = prompt('Новое название подкатегории:', oldName);
        if (newName === null) return;
        const newCode = generateCategoryCode(newName);
        try {
          const res = await fetchWithCsrf(`${API_BASE_URL}/api/subcategories/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: newName.trim(), code: newCode, category_code: currentCategoryCode })
          });
          const data = await res.json();
          if (data.success) {
            await loadSubcategories(currentCategoryCode);
          } else {
            subcategoriesError.textContent = data.message || 'Ошибка';
          }
        } catch (e) {
          subcategoriesError.textContent = 'Ошибка редактирования';
        }
      }
    });

    // Обработчики событий для модального окна категорий
    addSubcategoryForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      await addSubcategory();
    });
    
    // Кеш для хранения подкатегорий по категориям
    let subcategoriesCache = {};
    
    // Функция для загрузки подкатегорий при выборе категории в форме товара
    async function loadSubcategoriesForProduct() {
      const categoryCode = categoryInput.value;
      if (!categoryCode) {
        subcategoryInput.innerHTML = '<option value="">Выберите подкатегорию</option>';
        return;
      }
      
      try {
        // Если уже есть в кеше, используем кешированные данные
        if (subcategoriesCache[categoryCode]) {
          renderSubcategoriesSelect(subcategoriesCache[categoryCode]);
          return;
        }
        
        // Иначе загружаем с сервера
        subcategoryInput.innerHTML = '<option value="">Загрузка...</option>';
        const res = await fetchWithCsrf(`${API_BASE_URL}/api/subcategories?category=${encodeURIComponent(categoryCode)}`);
        const data = await res.json();
        
        if (data.success) {
          subcategoriesCache[categoryCode] = data.subcategories;
          renderSubcategoriesSelect(data.subcategories);
        } else {
          subcategoryInput.innerHTML = '<option value="">Ошибка загрузки</option>';
        }
      } catch (error) {
        console.error('Ошибка при загрузке подкатегорий:', error);
        subcategoryInput.innerHTML = '<option value="">Ошибка загрузки</option>';
      }
    }
    
    // Отображение подкатегорий в выпадающем списке
    function renderSubcategoriesSelect(subcategories) {
      if (!subcategories || subcategories.length === 0) {
        subcategoryInput.innerHTML = '<option value="">Нет подкатегорий</option>';
        return;
      }
      
      let html = '<option value="">Выберите подкатегорию</option>';
      subcategories.forEach(subcat => {
        html += `<option value="${subcat.code}">${subcat.name}</option>`;
      });
      
      subcategoryInput.innerHTML = html;
      
      // Если редактируем товар и у него есть подкатегория, выбираем её
      const currentSubcategory = subcategoryInput.getAttribute('data-current');
      if (currentSubcategory) {
        subcategoryInput.value = currentSubcategory;
        subcategoryInput.removeAttribute('data-current');
      }
    }

    // === Новый функционал для категорий ===
    showAddCategoryFormBtn.addEventListener('click', () => {
      addCategoryForm.style.display = 'flex';
      showAddCategoryFormBtn.style.display = 'none';
      addCategoryForm.reset();
      newCategoryImagePreview.innerHTML = '';
    });

    cancelAddCategoryBtn.addEventListener('click', () => {
      addCategoryForm.style.display = 'none';
      showAddCategoryFormBtn.style.display = '';
      addCategoryForm.reset();
      newCategoryImagePreview.innerHTML = '';
    });

    // Превью фото при загрузке с ПК
    newCategoryImage.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
          newCategoryImagePreview.innerHTML = `<img src="${e.target.result}" style="max-width:100px;max-height:100px;border-radius:6px;">`;
        };
        reader.readAsDataURL(this.files[0]);
        newCategoryImageUrl.value = '';
      } else {
        newCategoryImagePreview.innerHTML = '';
      }
    });
    // Превью фото по URL
    newCategoryImageUrl.addEventListener('input', function() {
      if (this.value) {
        newCategoryImagePreview.innerHTML = `<img src="${this.value}" style="max-width:100px;max-height:100px;border-radius:6px;">`;
        newCategoryImage.value = '';
      } else {
        newCategoryImagePreview.innerHTML = '';
      }
    });
    // Валидация фото при отправке формы
    addCategoryForm.addEventListener('submit', function(e) {
      const hasFile = newCategoryImage.files && newCategoryImage.files[0];
      const hasUrl = newCategoryImageUrl.value.trim();
      if (!hasFile && !hasUrl) {
        e.preventDefault();
        categoriesError.textContent = 'Добавьте фото категории (файл или URL)';
        return false;
      }
    });
    // Drag&Drop сортировка категорий (визуально)
    function makeCategoriesDraggable() {
      const items = categoriesList.querySelectorAll('li');
      items.forEach(item => {
        item.setAttribute('draggable', 'true');
        item.ondragstart = function(e) {
          dragSrcEl = this;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', this.innerHTML);
          this.classList.add('dragging');
        };
        item.ondragover = function(e) {
          e.preventDefault();
          this.classList.add('drag-over');
        };
        item.ondragleave = function() {
          this.classList.remove('drag-over');
        };
        item.ondrop = function(e) {
          e.stopPropagation();
          if (dragSrcEl !== this) {
            dragSrcEl.innerHTML = this.innerHTML;
            this.innerHTML = e.dataTransfer.getData('text/html');
          }
          this.classList.remove('drag-over');
          dragSrcEl.classList.remove('dragging');
          dragSrcEl = null;
        };
        item.ondragend = function() {
          this.classList.remove('dragging');
          items.forEach(i => i.classList.remove('drag-over'));
        };
      });
    }
    // Поиск по категориям
    categorySearch.addEventListener('input', function() {
      const val = this.value.toLowerCase();
      categoriesList.querySelectorAll('li').forEach(li => {
        const text = li.textContent.toLowerCase();
        li.style.display = text.includes(val) ? '' : 'none';
      });
    });
    // После закрытия подкатегорий — возвращаемся к списку категорий
    const backToCategoriesBtn = document.getElementById('backToCategoriesBtn');
    backToCategoriesBtn.addEventListener('click', () => {
      subcategoriesSection.style.display = 'none';
      categoriesListContainer.style.display = '';
    });

    // Функция для показа приветствия и интерактивного тура по интерфейсу
    function showCategoriesIntro() {
      // Проверяем, показывали ли мы уже тур
      const hasSeenTour = localStorage.getItem('categoriesIntroSeen');
      if (hasSeenTour) return;
      
      const welcomeAnimation = document.getElementById('welcomeAnimation');
      const startTourBtn = document.getElementById('startTourBtn');
      const searchTooltip = document.getElementById('searchTooltip');
      const addTooltip = document.getElementById('addTooltip');
      const listTooltip = document.getElementById('listTooltip');
      const subcatsTooltip = document.getElementById('subcatsTooltip');
      const skipButtons = document.querySelectorAll('.btn-skip');
      
      // Показываем приветственную анимацию
      welcomeAnimation.classList.add('active');
      
      // Функция для завершения тура
      function endTour() {
        document.querySelectorAll('.intro-tooltip').forEach(tooltip => {
          tooltip.classList.remove('active');
        });
        document.querySelectorAll('.highlight-element').forEach(el => {
          el.classList.remove('highlight-element');
        });
        localStorage.setItem('categoriesIntroSeen', 'true');
      }
      
      // Обработчики для кнопок пропуска
      skipButtons.forEach(btn => {
        btn.addEventListener('click', endTour);
      });
      
      // Запуск тура
      startTourBtn.addEventListener('click', function() {
        welcomeAnimation.classList.remove('active');
        
        // Показываем первую подсказку (поиск)
        setTimeout(() => {
          const searchContainer = document.querySelector('.search-container');
          searchContainer.classList.add('highlight-element');
          
          // Позиционируем подсказку
          const rect = searchContainer.getBoundingClientRect();
          searchTooltip.style.top = (rect.bottom + 10) + 'px';
          searchTooltip.style.left = rect.left + 'px';
          searchTooltip.classList.add('active');
          
          // Кнопка "Далее" для перехода к следующей подсказке
          searchTooltip.querySelector('.btn-next').addEventListener('click', function() {
            searchTooltip.classList.remove('active');
            searchContainer.classList.remove('highlight-element');
            
            // Показываем вторую подсказку (добавление категории)
            const addBtn = document.getElementById('showAddCategoryFormBtn');
            addBtn.classList.add('highlight-element');
            
            const addRect = addBtn.getBoundingClientRect();
            addTooltip.style.top = (addRect.top + addRect.height/2 - 50) + 'px';
            addTooltip.style.left = (addRect.left - 260) + 'px';
            addTooltip.classList.add('active');
            
            // Кнопка "Далее" для перехода к следующей подсказке
            addTooltip.querySelector('.btn-next').addEventListener('click', function() {
              addTooltip.classList.remove('active');
              addBtn.classList.remove('highlight-element');
              
              // Показываем третью подсказку (список категорий)
              const listContainer = document.getElementById('categoriesListContainer');
              listContainer.classList.add('highlight-element');
              
              const listRect = listContainer.getBoundingClientRect();
              listTooltip.style.top = (listRect.top + 30) + 'px';
              listTooltip.style.left = (listRect.right + 10) + 'px';
              listTooltip.classList.add('active');
              
              // Кнопка "Далее" для перехода к следующей подсказке
              listTooltip.querySelector('.btn-next').addEventListener('click', function() {
                listTooltip.classList.remove('active');
                listContainer.classList.remove('highlight-element');
                
                // Показываем четвертую подсказку (подкатегории)
                const subcatsSection = document.getElementById('subcategoriesSection');
                
                // Временно показываем секцию подкатегорий для демонстрации
                const originalDisplay = subcatsSection.style.display;
                subcatsSection.style.display = 'block';
                
                subcatsSection.classList.add('highlight-element');
                
                const subcatsRect = subcatsSection.getBoundingClientRect();
                subcatsTooltip.style.top = (subcatsRect.bottom + 10) + 'px';
                subcatsTooltip.style.left = (subcatsRect.left + 50) + 'px';
                subcatsTooltip.classList.add('active');
                
                // Кнопка "Завершить" для окончания тура
                subcatsTooltip.querySelector('.btn-next').addEventListener('click', function() {
                  subcatsTooltip.classList.remove('active');
                  subcatsSection.classList.remove('highlight-element');
                  subcatsSection.style.display = originalDisplay;
                  endTour();
                });
              });
            });
          });
        }, 300);
      });
    }
    
    // Запускаем интро при открытии модального окна категорий
    document.getElementById('manageCategoriesBtn').addEventListener('click', function() {
      setTimeout(showCategoriesIntro, 500); // Небольшая задержка для отрисовки модального окна
    });
    
    // Добавляем общую функцию для интро по всей админ-панели
    function initAdminPanelIntro() {
      // Создаем приветственную анимацию для админ-панели
      const adminWelcomeHTML = `
        <div class="welcome-animation" id="adminWelcomeAnimation">
          <h2>Панель администратора</h2>
          <p>Добро пожаловать в обновленную панель управления! Здесь вы можете управлять всеми аспектами вашего магазина.</p>
          <button class="btn-start" id="startAdminTourBtn">Начать знакомство <i class="fas fa-arrow-right"></i></button>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', adminWelcomeHTML);
      
      // Создаем подсказки для основных элементов админ-панели
      const tooltipsHTML = `
        <div class="intro-tooltip dashboard-tooltip top" id="dashboardTooltip">
          <h4>Панель управления</h4>
          <p>Здесь отображается общая статистика и основные показатели вашего магазина</p>
          <button class="btn-skip">Пропустить тур</button>
          <button class="btn-next">Далее <i class="fas fa-arrow-right"></i></button>
        </div>
        
        <div class="intro-tooltip products-tooltip right" id="productsTooltip">
          <h4>Управление товарами</h4>
          <p>Здесь вы можете добавлять, редактировать и удалять товары вашего магазина</p>
          <button class="btn-skip">Пропустить тур</button>
          <button class="btn-next">Далее <i class="fas fa-arrow-right"></i></button>
        </div>
        
        <div class="intro-tooltip orders-tooltip left" id="ordersTooltip">
          <h4>Заказы</h4>
          <p>Просматривайте и управляйте заказами клиентов</p>
          <button class="btn-skip">Пропустить тур</button>
          <button class="btn-next">Далее <i class="fas fa-arrow-right"></i></button>
        </div>
        
        <div class="intro-tooltip settings-tooltip bottom" id="settingsTooltip">
          <h4>Настройки</h4>
          <p>Настройте параметры вашего магазина и системы</p>
          <button class="btn-skip">Пропустить тур</button>
          <button class="btn-next">Завершить <i class="fas fa-check"></i></button>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', tooltipsHTML);
      
      // Проверяем, показывали ли мы уже тур по админ-панели
      const hasSeenAdminTour = localStorage.getItem('adminPanelIntroSeen');
      if (hasSeenAdminTour) return;
      
      const adminWelcomeAnimation = document.getElementById('adminWelcomeAnimation');
      const startAdminTourBtn = document.getElementById('startAdminTourBtn');
      const dashboardTooltip = document.getElementById('dashboardTooltip');
      const productsTooltip = document.getElementById('productsTooltip');
      const ordersTooltip = document.getElementById('ordersTooltip');
      const settingsTooltip = document.getElementById('settingsTooltip');
      const skipButtons = document.querySelectorAll('.btn-skip');
      
      // Показываем приветственную анимацию
      setTimeout(() => {
        adminWelcomeAnimation.classList.add('active');
      }, 1000);
      
      // Функция для завершения тура
      function endAdminTour() {
        document.querySelectorAll('.intro-tooltip').forEach(tooltip => {
          tooltip.classList.remove('active');
        });
        document.querySelectorAll('.highlight-element').forEach(el => {
          el.classList.remove('highlight-element');
        });
        localStorage.setItem('adminPanelIntroSeen', 'true');
      }
      
      // Обработчики для кнопок пропуска
      skipButtons.forEach(btn => {
        btn.addEventListener('click', endAdminTour);
      });
      
      // Запуск тура по админ-панели
      startAdminTourBtn.addEventListener('click', function() {
        adminWelcomeAnimation.classList.remove('active');
        
        // Показываем первую подсказку (дашборд)
        setTimeout(() => {
          const dashboardSection = document.querySelector('.dashboard-section') || document.querySelector('.main-stats');
          if (dashboardSection) {
            dashboardSection.classList.add('highlight-element');
            
            // Позиционируем подсказку
            const rect = dashboardSection.getBoundingClientRect();
            dashboardTooltip.style.top = (rect.bottom + 10) + 'px';
            dashboardTooltip.style.left = (rect.left + 50) + 'px';
            dashboardTooltip.classList.add('active');
            
            // Кнопка "Далее" для перехода к следующей подсказке
            dashboardTooltip.querySelector('.btn-next').addEventListener('click', function() {
              dashboardTooltip.classList.remove('active');
              dashboardSection.classList.remove('highlight-element');
              
              // Показываем вторую подсказку (товары)
              const productsSection = document.getElementById('productsTab') || document.querySelector('.products-section');
              if (productsSection) {
                productsSection.classList.add('highlight-element');
                
                const productsRect = productsSection.getBoundingClientRect();
                productsTooltip.style.top = (productsRect.top + 30) + 'px';
                productsTooltip.style.left = (productsRect.right + 10) + 'px';
                productsTooltip.classList.add('active');
                
                // Кнопка "Далее" для перехода к следующей подсказке
                productsTooltip.querySelector('.btn-next').addEventListener('click', function() {
                  productsTooltip.classList.remove('active');
                  productsSection.classList.remove('highlight-element');
                  
                  // Показываем третью подсказку (заказы)
                  const ordersSection = document.getElementById('ordersTab') || document.querySelector('.orders-section');
                  if (ordersSection) {
                    ordersSection.classList.add('highlight-element');
                    
                    const ordersRect = ordersSection.getBoundingClientRect();
                    ordersTooltip.style.top = (ordersRect.top + 30) + 'px';
                    ordersTooltip.style.left = (ordersRect.left - 260) + 'px';
                    ordersTooltip.classList.add('active');
                    
                    // Кнопка "Далее" для перехода к следующей подсказке
                    ordersTooltip.querySelector('.btn-next').addEventListener('click', function() {
                      ordersTooltip.classList.remove('active');
                      ordersSection.classList.remove('highlight-element');
                      
                      // Показываем четвертую подсказку (настройки)
                      const settingsSection = document.getElementById('settingsTab') || document.querySelector('.settings-section');
                      if (settingsSection) {
                        settingsSection.classList.add('highlight-element');
                        
                        const settingsRect = settingsSection.getBoundingClientRect();
                        settingsTooltip.style.top = (settingsRect.bottom + 10) + 'px';
                        settingsTooltip.style.left = (settingsRect.left + 50) + 'px';
                        settingsTooltip.classList.add('active');
                        
                        // Кнопка "Завершить" для окончания тура
                        settingsTooltip.querySelector('.btn-next').addEventListener('click', function() {
                          settingsTooltip.classList.remove('active');
                          settingsSection.classList.remove('highlight-element');
                          endAdminTour();
                        });
                      } else {
                        endAdminTour();
                      }
                    });
                  } else {
                    endAdminTour();
                  }
                });
              } else {
                endAdminTour();
              }
            });
          } else {
            endAdminTour();
          }
        }, 300);
      });
    }
    
    // Инициализируем тур по админ-панели при загрузке страницы
    document.addEventListener('DOMContentLoaded', initAdminPanelIntro);
    
    // Добавляем интерактивные подсказки для модальных окон
    function initModalIntros() {
      // Модальное окно товаров
      const productsBtn = document.getElementById('manageProductsBtn');
      if (productsBtn) {
        productsBtn.addEventListener('click', function() {
          setTimeout(showProductsIntro, 500);
        });
      }
      
      // Модальное окно заказов
      const ordersBtn = document.getElementById('manageOrdersBtn');
      if (ordersBtn) {
        ordersBtn.addEventListener('click', function() {
          setTimeout(showOrdersIntro, 500);
        });
      }
      
      // Модальное окно настроек
      const settingsBtn = document.getElementById('manageSettingsBtn');
      if (settingsBtn) {
        settingsBtn.addEventListener('click', function() {
          setTimeout(showSettingsIntro, 500);
        });
      }
    }
    
    // Поиск по товарам
    document.getElementById('productSearchInput').addEventListener('input', function() {
      const query = this.value.trim().toLowerCase();
      const all = window._allProducts || [];
      if (!query) {
        renderProducts(all);
        return;
      }
      const filtered = all.filter(p => {
        return (
          (p.title && p.title.toLowerCase().includes(query)) ||
          (p.sku && p.sku.toLowerCase().includes(query)) ||
          (p.category && getCategoryName(p.category).toLowerCase().includes(query))
        );
      });
      renderProducts(filtered);
    });

    // Drag&Drop сортировка товаров (визуально)
    function makeProductsDraggable() {
      const grid = productsContainer.querySelector('.products-grid');
      if (!grid) return;
      let dragSrcEl = null;
      grid.querySelectorAll('.product-card').forEach(card => {
        card.setAttribute('draggable', 'true');
        card.ondragstart = function(e) {
          dragSrcEl = this;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', this.outerHTML);
          this.classList.add('dragging');
        };
        card.ondragover = function(e) {
          e.preventDefault();
          this.classList.add('drag-over');
        };
        card.ondragleave = function() {
          this.classList.remove('drag-over');
        };
        card.ondrop = function(e) {
          e.stopPropagation();
          if (dragSrcEl !== this) {
            this.insertAdjacentHTML('beforebegin', e.dataTransfer.getData('text/html'));
            grid.removeChild(dragSrcEl);
            // Удаляем лишние классы
            grid.querySelectorAll('.dragging, .drag-over').forEach(el => el.classList.remove('dragging', 'drag-over'));
            makeProductsDraggable(); // Переинициализируем drag&drop
          }
        };
        card.ondragend = function() {
          this.classList.remove('dragging');
          grid.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        };
      });
    }
  </script>
  <script>
(async function() {
  if (window.location.pathname.startsWith('/admin')) return;
  try {
    const res = await fetch('/api/site-status');
    if (res.ok) {
      const data = await res.json();
      if (!data.enabled) {
        const cookies = document.cookie.split(';').map(s => s.trim());
        const adminToken = cookies.find(s => s.startsWith('admin_token='));
        if (!adminToken || !data.admin_token || adminToken.split('=')[1] !== data.admin_token) {
          window.location.href = '/site-offline.html';
        }
      }
    }
  } catch (e) {}
})();
  </script>
</body>
</html> 