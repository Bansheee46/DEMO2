<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Админ-панель | Управление заказами</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #3f51b5;
      --primary-color-rgb: 63, 81, 181;
      --primary-dark: #303f9f;
      --primary-dark-rgb: 48, 63, 159;
      --primary-light: #c5cae9;
      --primary-light-rgb: 197, 202, 233;
      --secondary-color: #00bcd4;
      --secondary-color-rgb: 0, 188, 212;
      --secondary-dark: #0097a7;
      --accent-color: #ff4081;
      --accent-color-rgb: 255, 64, 129;
      --light-color: #f5f5f5;
      --dark-color: #263238;
      --success-color: #4caf50;
      --success-color-rgb: 76, 175, 80;
      --warning-color: #ff9800;
      --warning-color-rgb: 255, 152, 0;
      --danger-color: #f44336;
      --danger-color-rgb: 244, 67, 54;
      --info-color: #2196f3;
      --info-color-rgb: 33, 150, 243;
      --border-radius: 12px;
      --card-border-radius: 16px;
      --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --box-shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: var(--dark-color);
      background-color: #f8fafc;
      background-image: linear-gradient(135deg, #f8fafc 0%, #eef2f7 100%);
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Боковое меню */
    .sidebar {
      width: 280px;
      background-color: #fff;
      box-shadow: var(--box-shadow);
      z-index: 100;
      transition: var(--transition);
      overflow-y: auto;
      border-radius: 0 24px 24px 0;
    }
    
    .sidebar-header {
      padding: 25px 20px;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .sidebar-header::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 200%;
      background: rgba(255, 255, 255, 0.1);
      transform: rotate(30deg);
      pointer-events: none;
    }
    
    .sidebar-header h2 {
      font-size: 22px;
      margin-bottom: 8px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    .sidebar-header p {
      font-size: 13px;
      opacity: 0.9;
      letter-spacing: 0.3px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      margin-bottom: 10px;
      background-color: rgba(var(--primary-light-rgb, 197, 202, 233), 0.1);
    }
    
    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-right: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .user-details {
      flex: 1;
    }
    
    .user-name {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 2px;
      color: var(--dark-color);
    }
    
    .user-role {
      font-size: 13px;
      color: #6b7280;
      letter-spacing: 0.3px;
    }
    
    .nav-menu {
      list-style: none;
      padding: 10px;
    }
    
    .nav-item {
      margin-bottom: 8px;
    }
    
    .nav-link {
      display: flex;
      align-items: center;
      padding: 14px 20px;
      color: #4b5563;
      text-decoration: none;
      transition: var(--transition);
      border-radius: 12px;
      font-weight: 500;
    }
    
    .nav-link:hover {
      background-color: rgba(var(--primary-light-rgb, 197, 202, 233), 0.15);
      color: var(--primary-color);
      transform: translateX(5px);
    }
    
    .nav-link.active {
      background: linear-gradient(to right, rgba(var(--primary-color-rgb, 63, 81, 181), 0.1), rgba(var(--primary-color-rgb, 63, 81, 181), 0.05));
      color: var(--primary-color);
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(var(--primary-color-rgb, 63, 81, 181), 0.1);
    }
    
    .nav-icon {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }
    
    .nav-text {
      flex: 1;
    }
    
    .nav-badge {
      background-color: var(--danger-color);
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 10px;
    }
    
    .nav-section {
      padding: 10px 20px;
      font-size: 12px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 15px;
    }
    
    /* Основное содержимое */
    .main-content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
    }
    
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--dark-color);
      letter-spacing: -0.5px;
    }
    
    .page-subtitle {
      font-size: 16px;
      color: #6b7280;
      margin-top: 5px;
    }
    
    /* Стили для фильтров заказов */
    .orders-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px 20px;
      background-color: white;
      border-radius: var(--card-border-radius);
      box-shadow: var(--box-shadow);
    }
    
    .filter-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .filter-label {
      font-weight: 500;
      color: #4b5563;
      font-size: 14px;
    }
    
    .filter-buttons {
      display: flex;
      gap: 5px;
    }
    
    .filter-btn {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid #e5e7eb;
      background-color: #f9fafb;
      color: #4b5563;
      transition: all 0.2s;
    }
    
    .filter-btn:hover {
      background-color: #f3f4f6;
      border-color: #d1d5db;
    }
    
    .filter-btn.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .search-box {
      display: flex;
      align-items: center;
      flex: 1;
      min-width: 200px;
      position: relative;
    }
    
    .search-box input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border: 1px solid #d1d5db;
      border-radius: 20px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .search-box input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.1);
    }
    
    .search-icon {
      position: absolute;
      left: 12px;
      color: #9ca3af;
      font-size: 14px;
    }
    
    /* Улучшенные стили для таблицы заказов */
    .orders-table-container {
      background-color: white;
      border-radius: var(--card-border-radius);
      box-shadow: var(--box-shadow);
      overflow: hidden;
      margin-bottom: 30px;
    }
    
    .orders-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .orders-table th {
      background-color: #f9fafb;
      padding: 15px 20px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      color: #4b5563;
      border-bottom: 1px solid #edf2f7;
    }
    
    .orders-table td {
      padding: 15px 20px;
      border-bottom: 1px solid #edf2f7;
      font-size: 14px;
      color: #4b5563;
      vertical-align: middle;
    }
    
    .orders-table tbody tr:hover {
      background-color: rgba(var(--primary-color-rgb), 0.03);
    }
    
    .order-number {
      font-weight: 600;
      color: var(--primary-color);
    }
    
    .order-date {
      color: #6b7280;
    }
    
    .customer-name {
      font-weight: 500;
    }
    
    .order-items-count {
      background-color: rgba(var(--primary-color-rgb), 0.1);
      color: var(--primary-color);
      border-radius: 20px;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 500;
      display: inline-block;
    }
    
    .order-total {
      font-weight: 600;
    }
    
    .order-actions-cell {
      display: flex;
      gap: 5px;
    }
    
    /* Пагинация */
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 5px;
    }
    
    .pagination-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      border: 1px solid #e5e7eb;
      background-color: #fff;
      color: #4b5563;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .pagination-btn:hover {
      background-color: #f3f4f6;
      border-color: #d1d5db;
    }
    
    .pagination-btn.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    
    .pagination-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s;
      backdrop-filter: blur(5px);
    }
    
    .modal-content {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 50px rgba(0,0,0,0.2);
      padding: 32px 24px;
      min-width: 340px;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      animation: slideUp 0.4s;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #edf2f7;
    }
    
    .modal-header h2 {
      font-size: 24px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .modal-header h2 i {
      color: var(--primary-color);
    }
    
    .close-modal {
      font-size: 28px;
      font-weight: bold;
      color: #888;
      cursor: pointer;
      transition: color 0.2s;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .close-modal:hover {
      color: #f44336;
      background-color: rgba(244, 67, 54, 0.1);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(30px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    .notification {
      position: fixed;
      top: 30px;
      right: 30px;
      z-index: 2000;
      background: #fff;
      color: #263238;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      padding: 16px 28px 16px 20px;
      font-size: 16px;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      transform: translateY(-20px);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      max-width: 500px;
    }
    
    .notification.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
    
    .notification::before {
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      font-size: 20px;
    }
    
    .notification.success {
      background: linear-gradient(to right, #e8f5e9, #f1f8e9);
      color: #2e7d32;
      border-left: 4px solid #4caf50;
    }
    
    .notification.success::before {
      content: '\f058';
      color: #4caf50;
    }
    
    .notification.error {
      background: linear-gradient(to right, #ffebee, #fce4ec);
      color: #c62828;
      border-left: 4px solid #f44336;
    }
    
    .notification.error::before {
      content: '\f057';
      color: #f44336;
    }
    
    .notification.info {
      background: linear-gradient(to right, #e3f2fd, #e8f5e9);
      color: #0277bd;
      border-left: 4px solid #2196f3;
    }
    
    .notification.info::before {
      content: '\f05a';
      color: #2196f3;
    }
    
    @keyframes fadeInRight {
      from {
        opacity: 0;
        transform: translateX(30px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Кнопки */
    .btn {
      display: inline-block;
      font-weight: 500;
      font-size: 15px;
      padding: 10px 22px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      outline: none;
      margin: 2px 0;
      box-shadow: 0 2px 8px rgba(63,81,181,0.04);
    }
    
    /* Компактные кнопки для таблицы */
    .order-actions-cell .btn {
      width: 36px;
      height: 36px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 14px;
    }
    
    .btn-primary {
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      color: #fff;
      box-shadow: 0 2px 8px rgba(63,81,181,0.08);
    }
    .btn-primary:hover {
      background: linear-gradient(90deg, var(--primary-dark), var(--secondary-dark));
      color: #fff;
    }
    .btn-secondary {
      background: #f5f5f5;
      color: var(--primary-color);
      border: 1px solid #e0e0e0;
    }
    .btn-secondary:hover {
      background: #e3e8f0;
      color: var(--primary-dark);
    }
    .btn-danger {
      background: #f44336;
      color: #fff;
      border: none;
    }
    .btn-danger:hover {
      background: #d32f2f;
      color: #fff;
    }
    
    /* Улучшенный счетчик товаров */
    .order-items-count {
      background-color: rgba(var(--primary-color-rgb), 0.1);
      color: var(--primary-color);
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      cursor: help;
    }
    
    .order-items-count.empty {
      background-color: rgba(var(--danger-color-rgb), 0.1);
      color: var(--danger-color);
    }
    /* Формы */
    .form-group {
      margin-bottom: 18px;
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      font-size: 14px;
      margin-bottom: 6px;
      color: #263238;
      font-weight: 500;
    }
    .form-control {
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 15px;
      background: #f9fafb;
      color: #263238;
      transition: border 0.2s;
    }
    .form-control:focus {
      border: 1.5px solid var(--primary-color);
      background: #fff;
      outline: none;
    }
    .form-actions {
      margin-top: 18px;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .order-item {
      display: flex;
      gap: 16px;
      align-items: flex-end;
      margin-bottom: 10px;
    }
    .remove-item {
      margin-left: 8px;
      margin-bottom: 2px;
    }
    /* Стили для информации о контрагенте */
    .counterparty-info {
      background-color: #f9fafb;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      border: 1px solid rgba(var(--primary-color-rgb), 0.1);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
    }
    
    .counterparty-info h3 {
      color: var(--primary-color);
      font-size: 18px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }
    
    .counterparty-info h3:before {
      content: '\f1ad';
      font-family: 'Font Awesome 5 Free';
      margin-right: 10px;
      color: var(--primary-color);
    }
    
    .counterparty-info p {
      margin-bottom: 8px;
      display: flex;
      align-items: baseline;
    }
    
    .counterparty-info p strong {
      min-width: 200px;
      color: #4b5563;
    }
    
    .order-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    @media (max-width: 768px) {
      .order-details {
        grid-template-columns: 1fr;
      }
    }
    
    .order-info, .customer-info {
      background-color: #f9fafb;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(var(--primary-color-rgb), 0.1);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
    }
    
    .order-info h3, .customer-info h3 {
      color: var(--primary-color);
      font-size: 18px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }
    
    .order-info h3:before {
      content: '\f07a';
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      margin-right: 10px;
      color: var(--primary-color);
    }
    
    .customer-info h3:before {
      content: '\f007';
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      margin-right: 10px;
      color: var(--primary-color);
    }
    
    .order-items {
      margin-top: 30px;
    }
    
    .order-items h3 {
      color: var(--primary-color);
      font-size: 18px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }
    
    .order-items h3:before {
      content: '\f07b';
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      margin-right: 10px;
      color: var(--primary-color);
    }
    
    .items-table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
    }
    
    .items-table th {
      background-color: var(--primary-color);
      color: white;
      padding: 12px 15px;
      text-align: left;
    }
    
    .items-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #edf2f7;
    }
    
    .items-table tbody tr:nth-child(even) {
      background-color: #f9fafb;
    }
    
    .items-table tbody tr:hover {
      background-color: rgba(var(--primary-color-rgb), 0.05);
    }
    
    .order-actions {
      margin-top: 30px;
      background-color: #f9fafb;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(var(--primary-color-rgb), 0.1);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
    }
    
    .order-actions h3 {
      color: var(--primary-color);
      font-size: 18px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }
    
    .order-actions h3:before {
      content: '\f013';
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      margin-right: 10px;
      color: var(--primary-color);
    }
    
    .order-actions h4 {
      color: #4b5563;
      font-size: 16px;
      margin-top: 15px;
      margin-bottom: 10px;
    }
    
    .status-change {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .status-change label {
      min-width: 120px;
    }
    
    .form-control {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.1);
    }
    
    .order-export {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .order-export button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .invoice-number {
      margin-top: 20px;
    }
    
    .input-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .input-group input {
      flex: 1;
    }
    
    .modal-content {
      max-width: 800px;
      width: 90%;
    }
    .order-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }
    
    .status-new {
      background-color: rgba(var(--info-color-rgb), 0.1);
      color: var(--info-color);
    }
    
    .status-processing {
      background-color: rgba(var(--warning-color-rgb), 0.1);
      color: var(--warning-color);
    }
    
    .status-shipped {
      background-color: rgba(var(--secondary-color-rgb), 0.1);
      color: var(--secondary-color);
    }
    
    .status-delivered {
      background-color: rgba(var(--success-color-rgb), 0.1);
      color: var(--success-color);
    }
    
    .status-cancelled {
      background-color: rgba(var(--danger-color-rgb), 0.1);
      color: var(--danger-color);
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Админ-панель</h2>
      <p>Управление заказами</p>
    </div>
    <div class="user-info">
      <div class="user-avatar">
        <i class="fas fa-user"></i>
      </div>
      <div class="user-details">
        <span class="user-name">Имя пользователя</span>
        <span class="user-role">Роль пользователя</span>
      </div>
    </div>
    <nav class="nav-menu">
      <a href="admin-dashboard.html" class="nav-item nav-link">
        <i class="fas fa-tachometer-alt nav-icon"></i>
        <span class="nav-text">Дашборд</span>
      </a>
      <a href="admin-panel.html" class="nav-item nav-link">
        <i class="fas fa-box nav-icon"></i>
        <span class="nav-text">Товары</span>
      </a>
      <a href="admin-orders.html" class="nav-item nav-link active">
        <i class="fas fa-shopping-cart nav-icon"></i>
        <span class="nav-text">Заказы</span>
      </a>
      <a href="admin-settings.html" class="nav-item nav-link">
        <i class="fas fa-cog nav-icon"></i>
        <span class="nav-text">Настройки</span>
      </a>
    </nav>
  </div>
  <div class="main-content">
    <div class="page-header">
      <h1 class="page-title">Управление заказами</h1>
      <div class="page-subtitle">Здесь вы можете управлять заказами</div>
    </div>
    <div class="orders-table-container">
      <div class="orders-table-header">
        <h3>Список заказов</h3>
        <div class="orders-table-actions">
          <button class="btn btn-primary">Добавить заказ</button>
        </div>
      </div>
      <div class="orders-filters">
        <div class="filter-group">
          <label class="filter-label">Статус:</label>
          <div class="filter-buttons">
            <button class="filter-btn" data-status="all">Все</button>
            <button class="filter-btn" data-status="new">Новый</button>
            <button class="filter-btn" data-status="processing">В обработке</button>
            <button class="filter-btn" data-status="shipped">Отправлен</button>
            <button class="filter-btn" data-status="delivered">Доставлен</button>
            <button class="filter-btn" data-status="cancelled">Отменен</button>
          </div>
        </div>
        <div class="search-box">
          <input type="text" id="order-search" placeholder="Поиск заказа...">
          <span class="search-icon"><i class="fas fa-search"></i></span>
        </div>
      </div>
      <table class="orders-table">
        <thead>
          <tr>
            <th><i class="fas fa-hashtag"></i> Номер заказа</th>
            <th><i class="far fa-calendar-alt"></i> Дата</th>
            <th><i class="fas fa-user"></i> Клиент</th>
            <th><i class="fas fa-shopping-basket"></i> Товары</th>
            <th><i class="fas fa-ruble-sign"></i> Сумма</th>
            <th><i class="fas fa-info-circle"></i> Статус</th>
            <th><i class="fas fa-cogs"></i> Действия</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <div class="pagination">
        <button class="pagination-btn" onclick="fetchOrders(1)">«</button>
        <button class="pagination-btn" onclick="fetchOrders(currentPage - 1)" class="disabled">‹</button>
        <span class="current-page">1</span>
        <button class="pagination-btn" onclick="fetchOrders(currentPage + 1)" class="disabled">›</button>
        <button class="pagination-btn" onclick="fetchOrders(totalPages)">»</button>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Получаем данные о текущем пользователе
      fetchUserData();
      
      // Проверяем, нужно ли очистить кэш
      clearAllCacheAndData();
      
      // Загружаем список заказов
      fetchOrders();
      
      // Добавляем обработчики событий для кнопок фильтрации и поиска
      setupEventListeners();
    });
    
    // Функция для загрузки списка заказов
    function fetchOrders(page = 1, forceRefresh = false) {
      // Показываем индикатор загрузки
      const ordersTableBody = document.querySelector('.orders-table tbody');
      ordersTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Загрузка данных...</td></tr>';
      
      const activeFilterBtn = document.querySelector('.filter-btn.active');
      const statusFilter = activeFilterBtn ? activeFilterBtn.dataset.status : 'all';
      const searchQuery = document.getElementById('order-search').value;

      // Если требуется принудительное обновление, игнорируем запрос к API
      if (forceRefresh) {
        // Отображаем пустую таблицу
        ordersTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Заказы не найдены</td></tr>';
        
        // Обновляем пагинацию
        const pagination = document.querySelector('.pagination');
        pagination.innerHTML = `
          <button class="pagination-btn disabled" onclick="fetchOrders(1)">«</button>
          <button class="pagination-btn disabled" onclick="fetchOrders(1)">‹</button>
          <span class="current-page">1</span>
          <button class="pagination-btn disabled" onclick="fetchOrders(1)">›</button>
          <button class="pagination-btn disabled" onclick="fetchOrders(1)">»</button>
        `;
        
        return;
      }

      let url = `/api/orders?page=${page}&status=${statusFilter}`;
      if (searchQuery) {
        url += `&search=${searchQuery}`;
      }

      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Исключаем заказы со статусом 'error' из всех фильтров
            const filteredOrders = data.orders.filter(order => order.status !== 'error');
            if (statusFilter === 'all') {
              // По умолчанию не показываем отмененные заказы, если не выбран фильтр "cancelled"
              renderOrders(filteredOrders.filter(order => order.status !== 'cancelled'), data.total_pages, page);
            } else if (statusFilter === 'cancelled') {
              renderOrders(filteredOrders.filter(order => order.status === 'cancelled'), data.total_pages, page);
            } else {
              renderOrders(filteredOrders.filter(order => order.status === statusFilter), data.total_pages, page);
            }
          } else {
            showNotification('Ошибка при загрузке заказов', 'error');
            ordersTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Ошибка при загрузке данных</td></tr>';
          }
        })
        .catch(error => {
          console.error('Ошибка при получении списка заказов:', error);
          showNotification('Ошибка при загрузке заказов', 'error');
          ordersTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Ошибка при загрузке данных</td></tr>';
        });
    }
    
    // Функция для получения информации о текущем пользователе
    function fetchUserData() {
      fetch('/api/auth/user')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.querySelector('.user-name').textContent = data.user.username;
            document.querySelector('.user-role').textContent = data.user.role;
          }
        })
        .catch(error => {
          console.error('Ошибка при получении данных пользователя:', error);
        });
    }
    
    // Функция для отображения списка заказов
    function renderOrders(orders, totalPages, currentPage) {
      const ordersTableBody = document.querySelector('.orders-table tbody');
      
      // Отладочная информация
      console.log('Получены данные заказов:', orders);
      console.log('Источник данных:', new Error().stack);
      
      // Проверяем, есть ли заказы после фильтрации
      if (!orders || orders.length === 0) {
        ordersTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Заказы не найдены</td></tr>';
        
        // Обновляем пагинацию для пустого списка
        const pagination = document.querySelector('.pagination');
        pagination.innerHTML = `
          <button class="pagination-btn disabled" onclick="fetchOrders(1)">«</button>
          <button class="pagination-btn disabled" onclick="fetchOrders(1)">‹</button>
          <span class="current-page">1</span>
          <button class="pagination-btn disabled" onclick="fetchOrders(1)">›</button>
          <button class="pagination-btn disabled" onclick="fetchOrders(1)">»</button>
        `;
        return;
      }
      
      ordersTableBody.innerHTML = '';
      
      orders.forEach(order => {
        const row = document.createElement('tr');
        // Форматируем дату
        const orderDate = new Date(order.created_at);
        const formattedDate = orderDate.toLocaleDateString('ru-RU');
        // Определяем класс статуса
        let statusClass = '';
        switch (order.status) {
          case 'new': statusClass = 'status-new'; break;
          case 'processing': statusClass = 'status-processing'; break;
          case 'shipped': statusClass = 'status-shipped'; break;
          case 'delivered': statusClass = 'status-delivered'; break;
          case 'cancelled': statusClass = 'status-cancelled'; break;
          default: statusClass = 'status-new';
        }
        // Переводим статус на русский
        let statusText = '';
        switch (order.status) {
          case 'new': statusText = 'Новый'; break;
          case 'processing': statusText = 'В обработке'; break;
          case 'shipped': statusText = 'Отправлен'; break;
          case 'delivered': statusText = 'Доставлен'; break;
          case 'cancelled': statusText = 'Отменен'; break;
          default: statusText = 'Новый';
        }
        
        // Форматируем сумму
        const formattedTotal = order.total_amount ? order.total_amount.toLocaleString() + ' ₽' : 'Не указана';
        
        // Создаем строку с товарами
        let itemsHtml = '';
        if (order.items && order.items.length > 0) {
          itemsHtml = `<span class="order-items-count" title="${order.items.map(item => `${item.title || 'Товар'} (${item.quantity} шт.)`).join('\n')}">
            <i class="fas fa-box"></i> ${order.items.length} ${pluralize(order.items.length, 'товар', 'товара', 'товаров')}
          </span>`;
        } else {
          itemsHtml = '<span class="order-items-count empty">Нет товаров</span>';
        }
        
        row.innerHTML = `
          <td class="order-number">${order.order_number || order.id}</td>
          <td class="order-date">${formattedDate}</td>
          <td class="customer-name">${order.customer_name}</td>
          <td>${itemsHtml}</td>
          <td class="order-total">${formattedTotal}</td>
          <td><span class="order-status ${statusClass}">${statusText}</span></td>
          <td class="order-actions-cell">
            <button class="btn btn-secondary" onclick="viewOrder(${order.id})"><i class="fas fa-eye"></i></button>
            <button class="btn btn-danger" onclick="cancelOrder(${order.id})"><i class="fas fa-times"></i></button>
          </td>
        `;
        ordersTableBody.appendChild(row);
      });

      // Обновляем пагинацию
      const pagination = document.querySelector('.pagination');
      pagination.innerHTML = ''; // Очищаем текущие кнопки
      pagination.innerHTML = `
        <button class="pagination-btn" onclick="fetchOrders(1)">«</button>
        <button class="pagination-btn" onclick="fetchOrders(${currentPage - 1})" class="disabled">‹</button>
        <span class="current-page">${currentPage}</span>
        <button class="pagination-btn" onclick="fetchOrders(${currentPage + 1})" class="disabled">›</button>
        <button class="pagination-btn" onclick="fetchOrders(${totalPages})">»</button>
      `;
      // Активируем кнопки пагинации
      document.querySelectorAll('.pagination-btn').forEach(btn => {
        // Преобразуем currentPage и totalPages в строки для сравнения
        const currentPageStr = String(currentPage);
        const totalPagesStr = totalPages ? String(totalPages) : '1';
        
        if (btn.textContent === currentPageStr) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
        
        // Проверяем первую кнопку
        if (btn.textContent === '«' || btn.textContent === '‹') {
          if (currentPage <= 1) {
            btn.classList.add('disabled');
          } else {
            btn.classList.remove('disabled');
          }
        }
        
        // Проверяем последнюю кнопку
        if (btn.textContent === '»' || btn.textContent === '›') {
          if (!totalPages || currentPage >= totalPages) {
            btn.classList.add('disabled');
          } else {
            btn.classList.remove('disabled');
          }
        }
      });
    }
    
    // Функция для склонения слов
    function pluralize(count, one, two, five) {
      let n = Math.abs(count);
      n %= 100;
      if (n >= 5 && n <= 20) {
        return five;
      }
      n %= 10;
      if (n === 1) {
        return one;
      }
      if (n >= 2 && n <= 4) {
        return two;
      }
      return five;
    }
    
    // Функция для просмотра деталей заказа
    function viewOrder(orderId) {
      // Показываем модальное окно с деталями заказа
      fetch(`/api/orders/${orderId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showOrderDetails(data.order);
          } else {
            showNotification('Ошибка при загрузке данных заказа', 'error');
          }
        })
        .catch(error => {
          console.error('Ошибка при получении данных заказа:', error);
          showNotification('Ошибка при загрузке данных заказа', 'error');
        });
    }
    
    // Функция для отображения деталей заказа
    function showOrderDetails(order) {
      // Создаем модальное окно
      const modal = document.createElement('div');
      modal.classList.add('modal');
      
      // Проверяем, есть ли данные о контрагенте
      const hasCounterpartyData = order.counterparty_data && Object.keys(order.counterparty_data).length > 0;
      
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h2><i class="fas fa-file-invoice"></i> Заказ #${order.order_number || order.id}</h2>
            <span class="close-modal">&times;</span>
          </div>
          <div class="modal-body">
            <div class="order-details">
              <div class="order-info">
                <h3>Информация о заказе</h3>
                <p><strong><i class="fas fa-hashtag"></i> Номер заказа:</strong> ${order.order_number || order.id}</p>
                <p><strong><i class="far fa-calendar-alt"></i> Дата заказа:</strong> ${new Date(order.created_at).toLocaleDateString('ru-RU')}</p>
                <p><strong><i class="fas fa-info-circle"></i> Статус:</strong> <span class="order-status ${getStatusClass(order.status)}">${getStatusText(order.status)}</span></p>
                <p><strong><i class="fas fa-ruble-sign"></i> Сумма заказа:</strong> ${order.total_amount ? order.total_amount.toLocaleString() + ' ₽' : 'Не указана'}</p>
                ${order.comment ? `<p><strong><i class="fas fa-comment"></i> Комментарий к заказу:</strong> ${order.comment}</p>` : ''}
                ${order.contact_method ? `<p><strong><i class="fas fa-phone-alt"></i> Предпочтительный способ связи:</strong> ${getContactMethodText(order.contact_method)}</p>` : ''}
              </div>
              <div class="customer-info">
                <h3>Информация о клиенте</h3>
                <p><strong><i class="fas fa-user"></i> Имя:</strong> ${order.customer_name}</p>
                <p><strong><i class="fas fa-envelope"></i> Email:</strong> ${order.customer_email || 'Не указан'}</p>
                <p><strong><i class="fas fa-phone"></i> Телефон:</strong> ${order.customer_phone || 'Не указан'}</p>
                <p><strong><i class="fas fa-map-marker-alt"></i> Адрес доставки:</strong> ${order.shipping_address || 'Не указан'}</p>
              </div>
              
              ${hasCounterpartyData ? `
              <div class="counterparty-info">
                <h3>Информация о контрагенте</h3>
                <p><strong><i class="fas fa-building"></i> Название компании:</strong> ${order.counterparty_data.company_name || 'Не указано'}</p>
                <p><strong><i class="fas fa-id-card"></i> ИНН:</strong> ${order.counterparty_data.company_inn || 'Не указан'}</p>
                <p><strong><i class="fas fa-id-card-alt"></i> КПП:</strong> ${order.counterparty_data.company_kpp || 'Не указан'}</p>
                <p><strong><i class="fas fa-file-alt"></i> ОГРН:</strong> ${order.counterparty_data.company_ogrn || 'Не указан'}</p>
                <p><strong><i class="fas fa-map-marked-alt"></i> Юридический адрес:</strong> ${order.counterparty_data.company_address || 'Не указан'}</p>
                <p><strong><i class="fas fa-user-tie"></i> Контактное лицо:</strong> ${order.counterparty_data.contact_name || 'Не указано'}</p>
                <p><strong><i class="fas fa-briefcase"></i> Должность:</strong> ${order.counterparty_data.contact_position || 'Не указана'}</p>
                <p><strong><i class="fas fa-phone-square"></i> Телефон контактного лица:</strong> ${order.counterparty_data.contact_phone || 'Не указан'}</p>
                <p><strong><i class="fas fa-envelope-square"></i> Email контактного лица:</strong> ${order.counterparty_data.contact_email || 'Не указан'}</p>
                ${order.counterparty_data.additional_info ? `<p><strong><i class="fas fa-info"></i> Дополнительная информация:</strong> ${order.counterparty_data.additional_info}</p>` : ''}
              </div>
              ` : ''}
            </div>
            <div class="order-items">
              <h3>Товары в заказе</h3>
              <table class="items-table">
                <thead>
                  <tr>
                    <th>ID товара</th>
                    <th>Наименование</th>
                    <th>Цена</th>
                    <th>Количество</th>
                    <th>Сумма</th>
                  </tr>
                </thead>
                <tbody>
                  ${renderOrderItems(order.items)}
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="4" style="text-align: right; font-weight: bold;">Итого:</td>
                    <td style="font-weight: bold;">${order.total_amount ? order.total_amount.toLocaleString() + ' ₽' : 'Не указана'}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
            <div class="order-actions">
              <h3>Действия с заказом</h3>
              <div class="status-change">
                <label for="order-status"><i class="fas fa-exchange-alt"></i> Изменить статус:</label>
                <select id="order-status" class="form-control">
                  <option value="new" ${order.status === 'new' ? 'selected' : ''}>Новый</option>
                  <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>В обработке</option>
                  <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Отправлен</option>
                  <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Доставлен</option>
                  <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Отменен</option>
                </select>
                <button class="btn btn-primary" onclick="updateOrderStatus(${order.id})"><i class="fas fa-save"></i> Сохранить</button>
              </div>
              <div class="order-export">
                <h4><i class="fas fa-file-export"></i> Экспорт заказа</h4>
                <button class="btn btn-secondary" onclick="exportOrderToExcel(${order.id})">
                  <i class="fas fa-file-excel"></i> Экспорт в Excel
                </button>
                <button class="btn btn-secondary" onclick="exportOrderTo1C(${order.id})">
                  <i class="fas fa-file-export"></i> Экспорт в 1C
                </button>
              </div>
              <div class="invoice-number">
                <h4><i class="fas fa-file-invoice-dollar"></i> Номер счета</h4>
                <div class="input-group">
                  <input type="text" id="invoice-number" class="form-control" placeholder="Введите номер счета" value="${order.invoice_number || ''}">
                  <button class="btn btn-primary" onclick="saveInvoiceNumber(${order.id})"><i class="fas fa-save"></i> Сохранить</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Добавляем обработчик для закрытия модального окна
      const closeModal = modal.querySelector('.close-modal');
      closeModal.addEventListener('click', function() {
        document.body.removeChild(modal);
      });
      
      // Закрытие модального окна при клике вне его содержимого
      window.addEventListener('click', function(event) {
        if (event.target === modal) {
          document.body.removeChild(modal);
        }
      });
    }
    
    // Функция для отмены заказа
    function cancelOrder(orderId) {
      if (confirm('Вы уверены, что хотите отменить этот заказ?')) {
        updateOrderStatusApi(orderId, 'cancelled')
          .then(data => {
            if (data.success) {
              showNotification('Статус заказа успешно обновлен', 'success');
              // Закрываем модальное окно, если оно открыто
              const modal = document.querySelector('.modal');
              if (modal) {
                document.body.removeChild(modal);
              }
              // Обновляем список заказов
              fetchOrders();
            } else {
              showNotification('Ошибка при обновлении статуса заказа', 'error');
            }
          })
          .catch(error => {
            console.error('Ошибка при обновлении статуса заказа:', error);
            showNotification('Ошибка при обновлении статуса заказа', 'error');
          });
      }
    }
    
    // Функция для обновления статуса заказа
    function updateOrderStatus(orderId) {
      const newStatus = document.getElementById('order-status').value;
      updateOrderStatusApi(orderId, newStatus);
    }
    
    // Функция для отправки запроса на обновление статуса заказа
    function updateOrderStatusApi(orderId, status) {
      return new Promise((resolve, reject) => {
        fetch(`/api/orders/${orderId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ status: status })
        })
          .then(response => {
            // Обрабатываем любой ответ, чтобы избежать прерывания цепочки Promise.all
            if (response.ok) {
              try {
                return response.json();
              } catch (e) {
                return { success: true };
              }
            } else {
              console.warn(`Ошибка при обновлении статуса заказа ${orderId}: ${response.status}`);
              return { success: false, error: response.status };
            }
          })
          .then(data => {
            resolve(data);
          })
          .catch(error => {
            console.error('Ошибка при обновлении статуса заказа:', error);
            // Не отклоняем промис, чтобы не прерывать цепочку Promise.all
            resolve({ success: false, error: error.message });
          });
      });
    }
    
    // Функция для отображения товаров в заказе
    function renderOrderItems(items) {
      if (!items || items.length === 0) {
        return '<tr><td colspan="5" style="text-align: center;">Товары не найдены</td></tr>';
      }
      
      let html = '';
      items.forEach(item => {
        const price = item.price || 0;
        const quantity = item.quantity || 0;
        const total = price * quantity;
        html += `
          <tr>
            <td>${item.product_id || 'Н/Д'}</td>
            <td>${item.product_name || item.title || 'Товар'}</td>
            <td>${price} ₽</td>
            <td>${quantity}</td>
            <td>${total} ₽</td>
          </tr>
        `;
      });
      
      return html;
    }
    
    // Функция для получения класса статуса
    function getStatusClass(status) {
      switch (status) {
        case 'new': return 'status-new';
        case 'processing': return 'status-processing';
        case 'shipped': return 'status-shipped';
        case 'delivered': return 'status-delivered';
        case 'cancelled': return 'status-cancelled';
        default: return 'status-new';
      }
    }
    
    // Функция для получения текста статуса
    function getStatusText(status) {
      switch (status) {
        case 'new': return 'Новый';
        case 'processing': return 'В обработке';
        case 'shipped': return 'Отправлен';
        case 'delivered': return 'Доставлен';
        case 'cancelled': return 'Отменен';
        default: return 'Новый';
      }
    }
    
    // Функция для получения текста способа связи
    function getContactMethodText(method) {
      switch (method) {
        case 'phone': return 'Телефон';
        case 'whatsapp': return 'WhatsApp';
        case 'telegram': return 'Telegram';
        case 'email': return 'Email';
        default: return method;
      }
    }
    
    // Функция для настройки обработчиков событий
    function setupEventListeners() {
      // Обработчик для кнопки добавления заказа
      const addOrderButton = document.querySelector('.orders-table-actions .btn-primary');
      if (addOrderButton) {
        addOrderButton.addEventListener('click', function() {
          showAddOrderForm();
        });
      }
      
      // Добавляем класс active к первой кнопке фильтра по умолчанию
      const firstFilterBtn = document.querySelector('.filter-btn');
      if (firstFilterBtn) {
        firstFilterBtn.classList.add('active');
      }
      
      // Обработчики для фильтров
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.filter-btn').forEach(fbtn => fbtn.classList.remove('active'));
          this.classList.add('active');
          fetchOrders(); // Перезагружаем заказы при изменении фильтра
        });
      });

      // Обработчик для поиска заказов
      document.getElementById('order-search').addEventListener('input', function() {
        fetchOrders(); // Перезагружаем заказы при вводе в поиск
      });
    }
    
    // Функция для отображения формы добавления заказа
    function showAddOrderForm() {
      // Создаем модальное окно с формой добавления заказа
      const modal = document.createElement('div');
      modal.classList.add('modal');
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h2>Добавить новый заказ</h2>
            <span class="close-modal">&times;</span>
          </div>
          <div class="modal-body">
            <form id="add-order-form">
              <h3>Информация о клиенте</h3>
              <div class="form-group">
                <label for="customer-name">Имя клиента</label>
                <input type="text" id="customer-name" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="customer-email">Email клиента</label>
                <input type="email" id="customer-email" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="customer-phone">Телефон клиента</label>
                <input type="tel" id="customer-phone" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="shipping-address">Адрес доставки</label>
                <textarea id="shipping-address" class="form-control" required></textarea>
              </div>
              
              <h3>Товары</h3>
              <div id="order-items">
                <div class="order-item">
                  <div class="form-group">
                    <label for="product-id-1">ID товара</label>
                    <input type="number" id="product-id-1" class="form-control product-id" required>
                  </div>
                  <div class="form-group">
                    <label for="product-quantity-1">Количество</label>
                    <input type="number" id="product-quantity-1" class="form-control product-quantity" min="1" value="1" required>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-secondary" onclick="addOrderItem()">Добавить товар</button>
              
              <div class="form-actions">
                <button type="submit" class="btn btn-primary">Сохранить заказ</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Добавляем обработчик для закрытия модального окна
      const closeModal = modal.querySelector('.close-modal');
      closeModal.addEventListener('click', function() {
        document.body.removeChild(modal);
      });
      
      // Закрытие модального окна при клике вне его содержимого
      window.addEventListener('click', function(event) {
        if (event.target === modal) {
          document.body.removeChild(modal);
        }
      });
      
      // Добавляем обработчик отправки формы
      const form = document.getElementById('add-order-form');
      form.addEventListener('submit', function(event) {
        event.preventDefault();
        saveOrder();
      });
    }
    
    // Функция для добавления поля товара в форму
    function addOrderItem() {
      const orderItems = document.getElementById('order-items');
      const itemCount = orderItems.children.length + 1;
      
      const orderItem = document.createElement('div');
      orderItem.classList.add('order-item');
      orderItem.innerHTML = `
        <div class="form-group">
          <label for="product-id-${itemCount}">ID товара</label>
          <input type="number" id="product-id-${itemCount}" class="form-control product-id" required>
        </div>
        <div class="form-group">
          <label for="product-quantity-${itemCount}">Количество</label>
          <input type="number" id="product-quantity-${itemCount}" class="form-control product-quantity" min="1" value="1" required>
        </div>
        <button type="button" class="btn btn-danger remove-item" onclick="removeOrderItem(this)">Удалить</button>
      `;
      
      orderItems.appendChild(orderItem);
    }
    
    // Функция для удаления поля товара из формы
    function removeOrderItem(button) {
      const orderItem = button.parentElement;
      orderItem.parentElement.removeChild(orderItem);
    }
    
    // Функция для сохранения заказа
    function saveOrder() {
      // Собираем данные из формы
      const customerName = document.getElementById('customer-name').value;
      const customerEmail = document.getElementById('customer-email').value;
      const customerPhone = document.getElementById('customer-phone').value;
      const shippingAddress = document.getElementById('shipping-address').value;
      // Собираем товары
      const items = [];
      const productIds = document.querySelectorAll('.product-id');
      const productQuantities = document.querySelectorAll('.product-quantity');
      for (let i = 0; i < productIds.length; i++) {
        const pid = parseInt(productIds[i].value);
        const qty = parseInt(productQuantities[i].value);
        if (!pid || !qty || qty < 1) {
          showNotification('ID товара и количество должны быть заполнены и больше 0', 'error');
          return;
        }
        items.push({ product_id: pid, quantity: qty });
      }
      // Формируем данные для отправки
      const orderData = {
        customer_name: customerName,
        customer_email: customerEmail,
        customer_phone: customerPhone,
        shipping_address: shippingAddress,
        items: items
      };
      // Отправляем запрос на сервер
      fetch('/api/orders', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(orderData)
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showNotification('Заказ успешно добавлен', 'success');
            // Закрываем модальное окно
            const modal = document.querySelector('.modal');
            if (modal) {
              document.body.removeChild(modal);
            }
            // Обновляем список заказов
            fetchOrders();
          } else {
            showNotification(data.message || 'Ошибка при добавлении заказа', 'error');
          }
        })
        .catch(error => {
          console.error('Ошибка при добавлении заказа:', error);
          showNotification('Ошибка при добавлении заказа', 'error');
        });
    }
    
    // Функция для отображения уведомлений
    function showNotification(message, type = 'info') {
      // Удаляем предыдущее уведомление, если оно есть
      const existingNotification = document.querySelector('.notification');
      if (existingNotification) {
        existingNotification.classList.remove('show');
        setTimeout(() => {
          existingNotification.remove();
        }, 300);
      }
      
      const notification = document.createElement('div');
      notification.classList.add('notification', type);
      
      // Добавляем иконку в зависимости от типа уведомления
      let iconClass = 'info-circle';
      if (type === 'success') iconClass = 'check-circle';
      if (type === 'error') iconClass = 'times-circle';
      
      notification.innerHTML = `<span class="notification-message">${message}</span>`;
      
      document.body.appendChild(notification);
      
      // Показываем уведомление
      setTimeout(() => {
        notification.classList.add('show');
        
        // Добавляем звуковой эффект, если доступен
        if (window.settingsModule && typeof window.settingsModule.playSound === 'function') {
          if (type === 'success') {
            window.settingsModule.playSound('success', 0.3);
          } else if (type === 'error') {
            window.settingsModule.playSound('error', 0.3);
          } else {
            window.settingsModule.playSound('notification', 0.3);
          }
        }
      }, 10);
      
      // Скрываем и удаляем уведомление через 4 секунды
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) {
            document.body.removeChild(notification);
          }
        }, 300);
      }, 4000);
      
      // Добавляем возможность закрыть уведомление по клику
      notification.addEventListener('click', () => {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) {
            document.body.removeChild(notification);
          }
        }, 300);
      });
    }

    (async function() {
      // Инициализация страницы
      setupEventListeners();
      fetchOrders();
    })();

    // Функция для экспорта заказа в Excel
    function exportOrderToExcel(orderId) {
      // Получаем данные заказа
      fetch(`/api/orders/${orderId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const order = data.order;
            
            // Создаем данные для CSV файла
            let csvContent = 'Номер заказа,Дата заказа,Клиент,Email,Телефон,Адрес,Статус,Сумма\n';
            csvContent += `${order.order_number || order.id},${new Date(order.created_at).toLocaleDateString('ru-RU')},${order.customer_name || ''},${order.customer_email || ''},${order.customer_phone || ''},${order.shipping_address || ''},${getStatusText(order.status)},${order.total_amount || 0}\n\n`;
            
            // Добавляем товары
            csvContent += 'ID товара,Наименование,Цена,Количество,Сумма\n';
            if (order.items && order.items.length > 0) {
              order.items.forEach(item => {
                const price = item.price || 0;
                const quantity = item.quantity || 0;
                const total = price * quantity;
                csvContent += `${item.product_id || ''},${item.title || item.product_name || 'Товар'},${price},${quantity},${total}\n`;
              });
            }
            
            // Если есть данные о контрагенте, добавляем их
            if (order.counterparty_data) {
              csvContent += '\nДанные контрагента\n';
              csvContent += `Название компании,${order.counterparty_data.company_name || ''}\n`;
              csvContent += `ИНН,${order.counterparty_data.company_inn || ''}\n`;
              csvContent += `КПП,${order.counterparty_data.company_kpp || ''}\n`;
              csvContent += `ОГРН,${order.counterparty_data.company_ogrn || ''}\n`;
              csvContent += `Юридический адрес,${order.counterparty_data.company_address || ''}\n`;
              csvContent += `Контактное лицо,${order.counterparty_data.contact_name || ''}\n`;
              csvContent += `Должность,${order.counterparty_data.contact_position || ''}\n`;
              csvContent += `Телефон,${order.counterparty_data.contact_phone || ''}\n`;
              csvContent += `Email,${order.counterparty_data.contact_email || ''}\n`;
            }
            
            // Создаем Blob и ссылку для скачивания
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `order_${order.order_number || order.id}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Обновляем статус экспорта в заказе
            updateOrderExportStatus(orderId, 'excel');
            
            showNotification('Заказ успешно экспортирован в Excel', 'success');
          } else {
            showNotification('Ошибка при экспорте заказа', 'error');
          }
        })
        .catch(error => {
          console.error('Ошибка при экспорте заказа:', error);
          showNotification('Ошибка при экспорте заказа', 'error');
        });
    }
    
    // Функция для экспорта заказа в 1C
    function exportOrderTo1C(orderId) {
      // Получаем данные заказа
      fetch(`/api/orders/${orderId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const order = data.order;
            
            // Создаем XML данные для 1C
            let xmlContent = '<?xml version="1.0" encoding="UTF-8"?>\n';
            xmlContent += '<Документ>\n';
            xmlContent += `  <Номер>${order.order_number || order.id}</Номер>\n`;
            xmlContent += `  <Дата>${new Date(order.created_at).toISOString().split('T')[0]}</Дата>\n`;
            xmlContent += `  <Статус>${getStatusText(order.status)}</Статус>\n`;
            xmlContent += `  <Сумма>${order.total_amount || 0}</Сумма>\n`;
            xmlContent += '  <Клиент>\n';
            xmlContent += `    <Имя>${order.customer_name || ''}</Имя>\n`;
            xmlContent += `    <Email>${order.customer_email || ''}</Email>\n`;
            xmlContent += `    <Телефон>${order.customer_phone || ''}</Телефон>\n`;
            xmlContent += `    <Адрес>${order.shipping_address || ''}</Адрес>\n`;
            xmlContent += '  </Клиент>\n';
            
            // Данные о контрагенте, добавляем их
            if (order.counterparty_data) {
              xmlContent += '  <Контрагент>\n';
              xmlContent += `    <Название>${order.counterparty_data.company_name || ''}</Название>\n`;
              xmlContent += `    <ИНН>${order.counterparty_data.company_inn || ''}</ИНН>\n`;
              xmlContent += `    <КПП>${order.counterparty_data.company_kpp || ''}</КПП>\n`;
              xmlContent += `    <ОГРН>${order.counterparty_data.company_ogrn || ''}</ОГРН>\n`;
              xmlContent += `    <ЮридическийАдрес>${order.counterparty_data.company_address || ''}</ЮридическийАдрес>\n`;
              xmlContent += `    <КонтактноеЛицо>${order.counterparty_data.contact_name || ''}</КонтактноеЛицо>\n`;
              xmlContent += `    <Должность>${order.counterparty_data.contact_position || ''}</Должность>\n`;
              xmlContent += `    <ТелефонКонтакта>${order.counterparty_data.contact_phone || ''}</ТелефонКонтакта>\n`;
              xmlContent += `    <EmailКонтакта>${order.counterparty_data.contact_email || ''}</EmailКонтакта>\n`;
              xmlContent += '  </Контрагент>\n';
            }
            
            // Добавляем товары
            xmlContent += '  <Товары>\n';
            if (order.items && order.items.length > 0) {
              order.items.forEach(item => {
                const price = item.price || 0;
                const quantity = item.quantity || 0;
                const total = price * quantity;
                xmlContent += '    <Товар>\n';
                xmlContent += `      <Ид>${item.product_id || ''}</Ид>\n`;
                xmlContent += `      <Наименование>${item.title || item.product_name || 'Товар'}</Наименование>\n`;
                xmlContent += `      <Цена>${price}</Цена>\n`;
                xmlContent += `      <Количество>${quantity}</Количество>\n`;
                xmlContent += `      <Сумма>${total}</Сумма>\n`;
                xmlContent += '    </Товар>\n';
              });
            }
            xmlContent += '  </Товары>\n';
            xmlContent += '</Документ>';
            
            // Создаем Blob и ссылку для скачивания
            const blob = new Blob([xmlContent], { type: 'application/xml;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `order_${order.order_number || order.id}.xml`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Обновляем статус экспорта в заказе
            updateOrderExportStatus(orderId, 'onec');
            
            showNotification('Заказ успешно экспортирован в 1C', 'success');
          } else {
            showNotification('Ошибка при экспорте заказа', 'error');
          }
        })
        .catch(error => {
          console.error('Ошибка при экспорте заказа:', error);
          showNotification('Ошибка при экспорте заказа', 'error');
        });
    }
    
    // Функция для сохранения номера счета
    function saveInvoiceNumber(orderId) {
      const invoiceNumber = document.getElementById('invoice-number').value;
      if (!invoiceNumber) {
        showNotification('Введите номер счета', 'error');
        return;
      }
      
      // Отправляем запрос на сохранение номера счета
      fetch(`/api/orders/${orderId}/invoice`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ invoice_number: invoiceNumber })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showNotification('Номер счета успешно сохранен', 'success');
          } else {
            showNotification('Ошибка при сохранении номера счета', 'error');
          }
        })
        .catch(error => {
          console.error('Ошибка при сохранении номера счета:', error);
          showNotification('Ошибка при сохранении номера счета', 'error');
        });
    }
    
    // Функция для обновления статуса экспорта заказа
    function updateOrderExportStatus(orderId, exportType) {
      fetch(`/api/orders/${orderId}/export-status`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ export_type: exportType })
      })
        .then(response => response.json())
        .then(data => {
          if (!data.success) {
            console.error('Ошибка при обновлении статуса экспорта заказа:', data.message);
          }
        })
        .catch(error => {
          console.error('Ошибка при обновлении статуса экспорта заказа:', error);
        });
    }
    
    // Функция для очистки всех заказов
    function clearAllOrders() {
      if (confirm('Вы уверены, что хотите удалить ВСЕ заказы? Это действие нельзя отменить!')) {
        showNotification('Удаление заказов...', 'info');
        
        // Получаем список всех заказов для удаления
        fetch('/api/orders')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.orders && data.orders.length > 0) {
              // Создаем массив промисов для удаления каждого заказа
              const deletePromises = data.orders.map(order => 
                deleteOrderById(order.id)
              );
              
              // Ждем выполнения всех запросов на удаление
              Promise.all(deletePromises)
                .then(() => {
                  showNotification('Все заказы успешно удалены', 'success');
                  
                  // Очищаем таблицу заказов без перезагрузки
                  const ordersTableBody = document.querySelector('.orders-table tbody');
                  ordersTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Заказы не найдены</td></tr>';
                  
                  // Очищаем пагинацию
                  const pagination = document.querySelector('.pagination');
                  pagination.innerHTML = `
                    <button class="pagination-btn disabled" onclick="fetchOrders(1)">«</button>
                    <button class="pagination-btn disabled" onclick="fetchOrders(1)">‹</button>
                    <span class="current-page">1</span>
                    <button class="pagination-btn disabled" onclick="fetchOrders(1)">›</button>
                    <button class="pagination-btn disabled" onclick="fetchOrders(1)">»</button>
                  `;
                })
                .catch(error => {
                  console.error('Ошибка при удалении заказов:', error);
                  showNotification('Произошла ошибка при удалении некоторых заказов. Попробуйте обновить страницу.', 'error');
                });
            } else {
              showNotification('Заказы не найдены или произошла ошибка', 'info');
            }
          })
          .catch(error => {
            console.error('Ошибка при получении списка заказов:', error);
            showNotification('Ошибка при получении списка заказов', 'error');
          });
      }
    }
    
    // Функция для удаления заказа по ID
    function deleteOrderById(orderId) {
      return new Promise((resolve, reject) => {
        // Используем PUT для изменения статуса заказа на "cancelled" вместо DELETE
        updateOrderStatusApi(orderId, 'cancelled')
          .then(data => {
            console.log(`Заказ ${orderId} помечен как отмененный`);
            resolve(data);
          })
          .catch(error => {
            console.error(`Ошибка при отмене заказа ${orderId}:`, error);
            // Не отклоняем промис, чтобы не прерывать цепочку Promise.all
            resolve({ success: false, error: error.message });
          });
      });
    }
    
    // Функция для полной очистки кэша и данных
    function clearAllCacheAndData() {
      if ('caches' in window) {
        caches.keys().then(function(keyList) {
          return Promise.all(keyList.map(function(key) {
            return caches.delete(key);
          }));
        });
      }
      
      // Если страница загружена с параметром очистки кэша
      if (window.location.search.includes('clearcache=true')) {
        // Удаляем все данные из таблицы заказов
        const ordersTableBody = document.querySelector('.orders-table tbody');
        if (ordersTableBody) {
          ordersTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Все заказы удалены</td></tr>';
        }
        
        // Очищаем URL от параметров
        setTimeout(() => {
          window.history.replaceState({}, document.title, window.location.pathname);
        }, 100);
      }
    }
    
    // Функция для анализа источника данных заказов
    function analyzeOrdersData() {
      showNotification('Анализ данных заказов...', 'info');
      
      // Создаем модальное окно для отображения результатов анализа
      const modal = document.createElement('div');
      modal.classList.add('modal');
      
      // Собираем информацию о возможных источниках данных
      const storageInfo = {
        localStorage: Object.keys(localStorage).filter(key => key.includes('order')),
        sessionStorage: Object.keys(sessionStorage).filter(key => key.includes('order')),
        cookies: document.cookie.split(';').filter(cookie => cookie.includes('order')),
        indexedDB: 'Проверка...',
        caches: 'Проверка...'
      };
      
      // Проверяем IndexedDB
      const dbNames = [];
      if (window.indexedDB) {
        const req = window.indexedDB.databases();
        if (req) {
          req.onsuccess = function() {
            dbNames.push(...req.result.map(db => db.name));
            updateModalContent();
          };
        }
      }
      
      // Проверяем кэш
      const cacheNames = [];
      if ('caches' in window) {
        caches.keys().then(function(names) {
          cacheNames.push(...names);
          updateModalContent();
        });
      }
      
      // Пытаемся найти скрытые элементы на странице
      const hiddenElements = Array.from(document.querySelectorAll('[style*="display: none"], [style*="visibility: hidden"], [hidden]'))
        .filter(el => el.textContent.includes('order') || el.innerHTML.includes('order'));
      
      // Проверяем наличие iframe
      const iframes = Array.from(document.querySelectorAll('iframe'));
      
      // Проверяем сетевые запросы
      const networkRequests = performance.getEntriesByType('resource')
        .filter(entry => entry.name.includes('order') || entry.name.includes('api'))
        .map(entry => ({
          url: entry.name,
          type: entry.initiatorType,
          duration: Math.round(entry.duration) + 'ms'
        }));
      
      function updateModalContent() {
        storageInfo.indexedDB = dbNames.join(', ') || 'Не найдено';
        storageInfo.caches = cacheNames.join(', ') || 'Не найдено';
        
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
              <h2><i class="fas fa-search"></i> Анализ источников данных</h2>
              <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
              <h3>Хранилища данных</h3>
              <div style="max-height: 400px; overflow-y: auto;">
                <h4>LocalStorage:</h4>
                <pre>${JSON.stringify(storageInfo.localStorage, null, 2) || 'Не найдено'}</pre>
                
                <h4>SessionStorage:</h4>
                <pre>${JSON.stringify(storageInfo.sessionStorage, null, 2) || 'Не найдено'}</pre>
                
                <h4>Cookies:</h4>
                <pre>${JSON.stringify(storageInfo.cookies, null, 2) || 'Не найдено'}</pre>
                
                <h4>IndexedDB:</h4>
                <pre>${storageInfo.indexedDB}</pre>
                
                <h4>Cache Storage:</h4>
                <pre>${storageInfo.caches}</pre>
                
                <h4>Скрытые элементы на странице:</h4>
                <pre>${hiddenElements.length > 0 ? hiddenElements.map(el => el.outerHTML).join('\n') : 'Не найдено'}</pre>
                
                <h4>iframes:</h4>
                <pre>${iframes.length > 0 ? iframes.map(iframe => iframe.src).join('\n') : 'Не найдено'}</pre>
                
                <h4>Сетевые запросы:</h4>
                <pre>${JSON.stringify(networkRequests, null, 2) || 'Не найдено'}</pre>
              </div>
              
              <div style="margin-top: 20px;">
                <h3>Действия</h3>
                <button class="btn btn-danger" onclick="hardReset()">Полный сброс данных</button>
                <button class="btn btn-secondary" onclick="inspectOrdersIn()">Анализ в консоли</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Добавляем обработчик для закрытия модального окна
        const closeModal = modal.querySelector('.close-modal');
        closeModal.addEventListener('click', function() {
          document.body.removeChild(modal);
        });
        
        // Закрытие модального окна при клике вне его содержимого
        window.addEventListener('click', function(event) {
          if (event.target === modal) {
            document.body.removeChild(modal);
          }
        });
      }
      
      // Первичное обновление содержимого модального окна
      updateModalContent();
    }
    
    // Функция для полного сброса данных
    function hardReset() {
      if (confirm('Вы уверены, что хотите выполнить полный сброс данных? Это действие нельзя отменить!')) {
        // Очищаем все хранилища
        localStorage.clear();
        sessionStorage.clear();
        
        // Удаляем все куки
        document.cookie.split(";").forEach(function(c) {
          document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
        });
        
        // Очищаем IndexedDB
        if (window.indexedDB) {
          const req = window.indexedDB.databases();
          if (req) {
            req.onsuccess = function() {
              req.result.forEach(db => {
                indexedDB.deleteDatabase(db.name);
              });
            };
          }
        }
        
        // Очищаем кэш
        if ('caches' in window) {
          caches.keys().then(function(names) {
            names.forEach(name => {
              caches.delete(name);
            });
          });
        }
        
        // Перезагружаем страницу с параметрами для обхода кэша
        showNotification('Выполняется полный сброс данных...', 'info');
        setTimeout(() => {
          window.location.href = window.location.pathname + '?nocache=' + Math.random() + '&hardreset=true&t=' + new Date().getTime();
        }, 1000);
      }
    }
    
    // Функция для анализа заказов в консоли
    function inspectOrdersIn() {
      console.clear();
      console.log('%c Анализ данных заказов ', 'background: #3f51b5; color: white; font-size: 16px; padding: 5px;');
      
      // Проверяем API
      fetch('/api/orders')
        .then(response => response.json())
        .then(data => {
          console.log('%c Данные с сервера:', 'font-weight: bold; color: #3f51b5;');
          console.log(data);
        })
        .catch(error => {
          console.error('Ошибка при получении данных с сервера:', error);
        });
      
      // Проверяем localStorage
      console.log('%c Данные в localStorage:', 'font-weight: bold; color: #3f51b5;');
      Object.keys(localStorage).forEach(key => {
        if (key.includes('order')) {
          try {
            console.log(key, JSON.parse(localStorage.getItem(key)));
          } catch (e) {
            console.log(key, localStorage.getItem(key));
          }
        }
      });
      
      // Проверяем sessionStorage
      console.log('%c Данные в sessionStorage:', 'font-weight: bold; color: #3f51b5;');
      Object.keys(sessionStorage).forEach(key => {
        if (key.includes('order')) {
          try {
            console.log(key, JSON.parse(sessionStorage.getItem(key)));
          } catch (e) {
            console.log(key, sessionStorage.getItem(key));
          }
        }
      });
      
      showNotification('Данные выведены в консоль (F12)', 'info');
    }

    // Функция для массовой установки статуса ERROR для заданных id
    function markOrdersAsError(orderIds) {
      if (!Array.isArray(orderIds) || orderIds.length === 0) return;
      showNotification('Устанавливаем статус ERROR для выбранных заказов...', 'info');
      const promises = orderIds.map(id => updateOrderStatusApi(id, 'error'));
      Promise.all(promises)
        .then(() => {
          showNotification('Статус ERROR установлен для выбранных заказов', 'success');
          fetchOrders();
        })
        .catch(() => {
          showNotification('Ошибка при установке статуса ERROR', 'error');
        });
    }
  </script>
</body>
</html>